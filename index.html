<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코코포리아 로그 변환기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

body {
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f3f4f6;
    margin: 0;
    padding: 0;
}

#preview-frame {
    transition: opacity 0.3s ease-in-out;
}

input[type="number"]:disabled {
    background-color: #f3f4f6;
    cursor: not-allowed;
}
</style>
    <style>
        body {
            background: #0f0f0f;
            min-height: 100vh;
        }

        /* 헤더 스타일 */
        .hero-title {
            color: #f87171;
        }

        /* 카드 스타일 */
        .card {
            background: #1a1a1a !important;
            border: 1px solid #333;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .card:hover {
            border-color: #7f1d1d;
        }

        .card-primary {
            background: #1e1e1e !important;
            border: 1px solid #7f1d1d;
        }

        /* 섹션 헤더 */
        .section-header {
            color: #fca5a5 !important;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid #7f1d1d;
        }

        /* 입력 필드 */
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select {
            background: #1a1a1a !important;
            border: 1px solid #333 !important;
            color: #e5e7eb !important;
            border-radius: 6px;
            padding: 0.5rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #7f1d1d !important;
            outline: none;
        }

        input[type="file"] {
            padding: 0.5rem;
        }

        input[type="file"]::file-selector-button {
            background: #7f1d1d;
            color: #fca5a5;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 0.75rem;
            transition: background 0.2s;
        }

        input[type="file"]::file-selector-button:hover {
            background: #991b1b;
        }

        /* 라디오/체크박스 */
        input[type="radio"],
        input[type="checkbox"] {
            accent-color: #7f1d1d;
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        /* 라벨 */
        label {
            color: #d1d5db !important;
            font-weight: 400;
        }

        .label-description {
            color: #9ca3af !important;
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        /* Details/Summary */
        details {
            background: #1a1a1a !important;
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        details summary {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 500;
            color: #f87171 !important;
            background: #1a1a1a;
            transition: background 0.2s;
            user-select: none;
        }

        details summary:hover {
            background: #222;
            color: #fca5a5 !important;
        }

        details[open] summary {
            border-bottom: 1px solid #333;
            color: #fca5a5 !important;
        }

        details .details-content {
            padding: 1rem;
        }

        /* 버튼 */
        .btn-primary {
            background: #7f1d1d !important;
            color: #fca5a5 !important;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #991b1b !important;
        }

        .btn-primary:active {
            background: #7f1d1d !important;
        }

        .btn-download {
            background: #065f46;
            color: #6ee7b7;
            font-weight: 500;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-download:hover {
            background: #047857;
        }

        /* 색상 입력 */
        input[type="color"] {
            background: #1a1a1a !important;
            border: 1px solid #333 !important;
            border-radius: 4px;
            cursor: pointer;
            height: 2.2rem;
        }

        input[type="color"]:hover {
            border-color: #7f1d1d !important;
        }

        /* Select */
        select {
            cursor: pointer;
        }

        select option {
            background: #1a1a1a;
            color: #e5e7eb;
        }

        /* Placeholder */
        ::placeholder {
            color: #6b7280 !important;
        }

        /* 상태 메시지 */
        #status {
            background: #7f1d1d !important;
            border: 1px solid #991b1b !important;
            color: #fca5a5 !important;
            border-radius: 6px;
            padding: 0.75rem;
            font-weight: 400;
        }

        /* Preview Frame */
        #preview-frame {
            border: 1px solid #333 !important;
            border-radius: 6px;
            background: white;
        }

        /* 프로필 아이템 */
        .profile-card, .color-card {
            background: #222 !important;
            border: 1px solid #333 !important;
            border-radius: 6px;
            padding: 0.75rem;
            transition: border-color 0.2s;
        }

        .profile-card:hover, .color-card:hover {
            border-color: #7f1d1d !important;
        }

        /* 링크 */
        a {
            color: #f87171 !important;
            transition: color 0.2s;
        }

        a:hover {
            color: #fca5a5 !important;
        }

        /* Code */
        code {
            background-color: #3a3a3a !important;
            color: #e5e7eb !important;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }

        /* 스타일 선택 라디오 */
        .style-option {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            transition: border-color 0.2s;
            display: flex;
            align-items: center;
            min-height: 40px;
        }

        .style-option:hover {
            border-color: #7f1d1d;
        }

        .style-option input[type="radio"] {
            margin: 0;
        }

        .style-option label {
            margin: 0;
            margin-left: 0.5rem;
        }

        .style-option input:checked + label {
            color: #fca5a5 !important;
        }

        /* 탭 스타일 */
        .tab-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
        }

        .tab-buttons {
            display: flex;
            background: #111;
            border-bottom: 1px solid #333;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            border-right: 1px solid #333;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button:hover {
            background: #1a1a1a;
            color: #d1d5db;
        }

        .tab-button.active {
            background: #1a1a1a;
            color: #fca5a5;
            border-bottom: 2px solid #7f1d1d;
        }

        .tab-content {
            padding: 1rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 유틸리티 */
        .text-muted {
            color: #9ca3af !important;
        }

        .text-highlight {
            color: #fca5a5 !important;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-6 max-w-5xl">
        <!-- 헤더 -->
        <header class="text-center mb-6">
            <h1 class="hero-title text-3xl md:text-4xl font-bold mb-2">
                코코포리아 로그 변환기
            </h1>
            <p class="text-gray-400 text-base">만두 좀 드셔보실 분</p>
        </header>

        <main class="space-y-4">
            <!-- 기본 설정 카드 -->
            <div class="card card-primary p-4 md:p-5">
                <h2 class="section-header">시작하기</h2>

                <div class="grid md:grid-cols-2 gap-5">
                    <!-- 파일 업로드 -->
                    <div>
                        <label for="logFile" class="block mb-1.5">📁 로그 파일</label>
                        <input type="file" id="logFile" accept=".html" class="block w-full"/>
                        <p class="label-description mt-1">코코포리아에서 다운로드한 HTML 파일을 선택하세요</p>
                    </div>

                    <!-- 스타일 선택 -->
                    <div>
                        <label class="block mb-1.5">🎨 출력 스타일</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="style-option">
                                <input type="radio" name="style" value="novel" id="style-novel" checked>
                                <label for="style-novel" class="cursor-pointer">소설</label>
                            </div>
                            <div class="style-option">
                                <input type="radio" name="style" value="timeline" id="style-timeline">
                                <label for="style-timeline" class="cursor-pointer">타임라인</label>
                            </div>
                            <div class="style-option">
                                <input type="radio" name="style" value="original" id="style-original">
                                <label for="style-original" class="cursor-pointer">코코포리아<br>디자인</label>
                            </div>
                        </div>
                        <p class="label-description mt-1">원하는 출력 형식을 선택하세요</p>
                    </div>
                </div>
            </div>

            <!-- 상세 설정 섹션 -->
            <section id="profile-settings" class="hidden">
                <div class="tab-container">
                    <!-- 탭 버튼 -->
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="tab-basic">📝 기본</button>
                        <button class="tab-button" data-tab="tab-styling">🎨 스타일링</button>
                        <button class="tab-button" data-tab="tab-advanced">⚙️ 고급</button>
                    </div>

                    <!-- 탭 1: 기본 -->
                    <div id="tab-basic" class="tab-content active space-y-4">
                        <!-- 제목 설정 -->
                        <div>
                            <label class="block mb-1.5">제목 및 부제목</label>
                            <input type="text" id="custom-title" placeholder="제목" class="w-full mb-2">
                            <input type="text" id="custom-subtitle" placeholder="부제목" class="w-full mb-2">
                            <input type="text" id="custom-summary" placeholder="요약 (선택)" class="w-full">
                            <p class="label-description mt-1">파일명에서 자동 추출되며, 직접 수정할 수 있습니다</p>
                        </div>

                        <!-- 나레이터 -->
                        <div>
                            <label class="block mb-1.5">나레이터 지정</label>
                            <select id="narrator-select" class="w-full">
                                <option value="GM">GM (기본값)</option>
                            </select>
                            <p class="label-description">선택한 화자의 대사가 나레이션으로 표시됩니다</p>
                        </div>

                        <!-- 잡담 탭 지정 -->
                        <div>
                            <label class="block mb-1.5">잡담 탭 지정</label>
                            <select id="ooc-tab-select" class="w-full">
                                <option value="">사용 안 함</option>
                            </select>
                            <p class="label-description">선택한 탭이 잡담 메시지로 처리됩니다</p>
                        </div>

                        <!-- 서브 나레이터 -->
                        <div id="sub-narrator-section" class="hidden">
                            <details open>
                                <summary class="cursor-pointer mb-3">
                                    <span class="text-base font-semibold text-gray-200">서브 나레이터 지정</span>
                                </summary>
                                <p class="label-description mb-3">나레이션처럼 표시할 화자를 추가하고, 각각의 스타일을 지정할 수 있습니다.</p>

                                <!-- 추가 컨트롤 -->
                                <div class="flex gap-2 mb-4">
                                    <select id="sub-narrator-speaker-select" class="flex-1 bg-gray-700 border-gray-600 text-gray-200 text-sm px-3 py-2 rounded">
                                        <option value="">서브 나레이터로 지정할 화자 선택</option>
                                        <!-- JavaScript가 채움 -->
                                    </select>
                                    <button id="sub-narrator-add-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-200 text-sm rounded border border-gray-600 transition-colors">추가</button>
                                </div>

                                <!-- 서브 나레이터 목록 -->
                                <div id="sub-narrator-list" class="space-y-3">
                                    <p class="text-center text-gray-500 text-sm py-4" id="sub-narrator-empty-message">설정된 서브 나레이터가 없습니다.</p>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- 탭 2: 스타일링 -->
                    <div id="tab-styling" class="tab-content space-y-4">
                        <!-- 프로필 이미지 -->
                        <div id="profile-image-section" class="hidden">
                            <label class="block mb-2">🖼️ 프로필 이미지 <span class="text-sm text-muted">(타임라인, 코코포리아 디자인)</span></label>
                            <div id="profile-uploader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                <!-- JavaScript가 채움 -->
                            </div>
                        </div>

                        <!-- 캐릭터 색상 -->
                        <div id="character-color-section" style="display:none;">
                            <label class="block mb-2">🎨 캐릭터 이름 색상</label>
                            <p class="label-description mb-3">각 캐릭터의 이름 색상을 지정할 수 있습니다</p>
                            <div id="character-color-picker" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                <!-- JavaScript가 채움 -->
                            </div>
                        </div>

                        <!-- 폰트 및 레이아웃 -->
                        <div>
                            <label class="block mb-2">✏️ 폰트 및 레이아웃</label>
                            <div class="space-y-4">
                        <!-- 소설 스타일 가독성 향상 옵션 -->
                        <div id="novel-typography-option" class="hidden">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="novel-typography-toggle" class="mr-2">
                                <span>소설 스타일 가독성 향상 적용</span>
                            </label>
                            <p class="label-description ml-6">문단 첫 줄 들여쓰기, 자간/어간 미세 조정을 적용합니다.</p>
                        </div>

                        <!-- 커스텀 폰트 -->
                        <div>
                            <label class="block mb-1.5">커스텀 폰트 (선택)</label>
                            <input type="text" id="custom-font-url" placeholder="https://fonts.googleapis.com/css2?family=..." class="w-full mb-2">
                            <input type="text" id="custom-font-family" placeholder="폰트 이름 (예: 'Noto Serif KR')" class="w-full">

                            <details class="mt-3 border-none">
                                <summary class="text-sm !text-violet-400 hover:!text-violet-300 !p-0 !bg-transparent">📖 폰트 사용 가이드</summary>
                                <div class="mt-3 p-4 bg-gray-800 border border-gray-600 rounded-lg text-sm space-y-4">
                                    <div>
                                        <strong class="text-gray-200 block mb-2">1️⃣ Google Fonts</strong>
                                        <ol class="list-decimal ml-5 text-gray-300 space-y-1">
                                            <li><a href="https://fonts.google.com" target="_blank" class="!text-violet-400 hover:underline">fonts.google.com</a> 접속</li>
                                            <li>원하는 폰트 검색 (예: Noto Serif KR)</li>
                                            <li>"Get font" → "Get embed code" 클릭</li>
                                            <li>&lt;link&gt; 탭에서 <strong>href URL</strong> 복사</li>
                                            <li><strong>폰트 URL:</strong> <code>https://fonts.googleapis.com/css2?family=...</code></li>
                                            <li><strong>폰트 이름:</strong> <code>'Noto Serif KR'</code> (작은따옴표 포함)</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <strong class="text-gray-200 block mb-2">2️⃣ 눈누 (noonnu.cc)</strong>
                                        <ol class="list-decimal ml-5 text-gray-300 space-y-1">
                                            <li><a href="https://noonnu.cc" target="_blank" class="!text-violet-400 hover:underline">noonnu.cc</a> 접속</li>
                                            <li>폰트 선택 → "웹폰트로 사용" 섹션 찾기</li>
                                            <li><code>@import url('...')</code>에서 url() 안의 주소만 복사</li>
                                            <li><strong>폰트 이름:</strong> font-family: 뒤의 이름 복사 (작은따옴표 포함)</li>
                                        </ol>
                                    </div>
                                    <div class="bg-amber-900 border-l-4 border-amber-600 p-3 rounded">
                                        <p class="text-amber-200 text-xs"><strong>⚠️ 주의:</strong> 폰트 이름은 반드시 작은따옴표('')로 감싸서 입력하세요</p>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- 레이아웃 옵션 -->
                        <div>
                            <label class="block mb-2">레이아웃 옵션</label>
                            <div class="grid md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs mb-1 text-muted">폰트 크기</label>
                                    <select id="font-size" class="w-full">
                                        <option value="15">작게 (15px)</option>
                                        <option value="17" selected>기본 (17px)</option>
                                        <option value="19">크게 (19px)</option>
                                        <option value="21">매우 크게 (21px)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">줄간격</label>
                                    <select id="line-height" class="w-full">
                                        <option value="1.5">좁게 (1.5)</option>
                                        <option value="1.8" selected>기본 (1.8)</option>
                                        <option value="2.0">넓게 (2.0)</option>
                                        <option value="2.2">매우 넓게 (2.2)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">페이지 너비</label>
                                    <select id="page-width" class="w-full">
                                        <option value="600">좁게 (600px)</option>
                                        <option value="750" selected>기본 (750px)</option>
                                        <option value="900">넓게 (900px)</option>
                                        <option value="1200">매우 넓게 (1200px)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>

                    <!-- 탭 3: 고급 -->
                    <div id="tab-advanced" class="tab-content space-y-4">
                        <!-- 콘텐츠 표시 옵션 -->
                        <div>
                            <label class="block mb-2">⚙️ 콘텐츠 표시 옵션</label>
                            <div class="space-y-4">
                        <!-- 연속 발언 병합 -->
                        <div>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="merge-consecutive" class="mr-2">
                                <span>동일 화자 연속 발언 병합</span>
                            </label>
                            <p class="label-description ml-6">같은 화자가 연속으로 말할 때 하나로 합쳐 표시합니다</p>
                        </div>

                        <!-- 잡담 메시지 -->
                        <div>
                            <label class="block mb-1.5">잡담 메시지</label>
                            <select id="chat-mode" class="w-full mb-2">
                                <option value="collapse" selected>접기 (기본)</option>
                                <option value="show">모두 보이기</option>
                                <option value="hide">완전히 숨기기</option>
                            </select>
                            <label class="flex items-center cursor-pointer mt-2">
                                <input type="checkbox" id="show-chat-count" class="mr-2" checked>
                                <span class="text-sm">잡담 메시지 개수 표시</span>
                            </label>
                            <p class="label-description ml-6">접기 모드일 때 개수를 표시합니다</p>
                        </div>

                        <!-- 시스템 메시지 -->
                        <div>
                            <label class="block mb-1.5">시스템 메시지 (주사위)</label>
                            <select id="system-mode" class="w-full">
                                <option value="show" selected>표시 (기본)</option>
                                <option value="hide">숨기기</option>
                            </select>
                        </div>

                        <!-- 탭 스타일 설정 -->
                        <div id="tab-style-section" class="hidden">
                            <label class="block mb-1.5">커스텀 탭 스타일</label>
                            <p class="label-description mb-3">각 탭의 표시 방식을 지정할 수 있습니다</p>
                            <div id="tab-style-picker" class="space-y-2">
                                <!-- JavaScript가 동적으로 채움 -->
                            </div>
                        </div>
                            </div>
                        </div>

                        <!-- 고급 색상 설정 -->
                        <div>
                            <label class="block mb-2">🎨 고급 색상 설정</label>

                            <!-- 프리셋 선택 -->
                            <div class="mb-4">
                                <label class="block mb-1.5 text-sm">색상 프리셋</label>
                                <select id="color-preset" class="w-full">
                                    <option value="black-red">연연 테마(기본)</option>
                                    <option value="judgment">판정 테마</option>
                                    <option value="monochrome">흑백</option>
                                    <option value="pastel">파스텔</option>
                                    <option value="ocean">바다</option>
                                    <option value="pink">연핑크</option>
                                    <option value="spring">🌸 봄</option>
                                    <option value="summer">🌊 여름</option>
                                    <option value="autumn">🍂 가을</option>
                                    <option value="winter">❄️ 겨울</option>
                                    <option value="ccfolia">코코포리아 디폴트</option>
                                    <option value="custom">사용자 정의</option>
                                </select>
                                <p class="label-description mt-1">프리셋 선택 시 모든 색상이 자동으로 변경됩니다</p>
                            </div>

                            <div class="space-y-4">
                        <!-- 시스템 메시지 스타일 -->
                        <div>
                            <label class="block mb-2">시스템 메시지 스타일 (주사위)</label>
                            <div class="grid md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs mb-1 text-muted">배경 색상</label>
                                    <input type="color" id="system-bg-color" value="#f0f9ff" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">테두리 색상</label>
                                    <input type="color" id="system-border-color" value="#0ea5e9" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">텍스트 색상</label>
                                    <input type="color" id="system-text-color" value="#075985" class="w-full">
                                </div>
                            </div>
                        </div>

                        <!-- GM 나레이션 스타일 (타임라인용) -->
                        <div>
                            <label class="block mb-2">GM 나레이션 스타일 (타임라인)</label>
                            <div class="grid md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs mb-1 text-muted">배경 색상</label>
                                    <input type="color" id="narration-bg-color" value="#2a2a2a" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">텍스트 색상</label>
                                    <input type="color" id="narration-text-color" value="#9ca3af" class="w-full">
                                </div>
                            </div>
                        </div>

                        <!-- 전체 테마 색상 -->
                        <div>
                            <label class="block mb-2">전체 테마 색상</label>
                            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs mb-1 text-muted">배경 색상</label>
                                    <input type="color" id="theme-bg-color" value="#0a0a0a" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">컨테이너 색상</label>
                                    <input type="color" id="theme-container-color" value="#1e1e1e" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">텍스트 색상</label>
                                    <input type="color" id="theme-text-color" value="#e5e7eb" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-xs mb-1 text-muted">강조 색상</label>
                                    <input type="color" id="theme-accent-color" value="#7f1d1d" class="w-full">
                                </div>
                            </div>
                        </div>

                        <!-- 탭별 색상 커스터마이징 -->
                        <div id="tab-color-section" class="hidden">
                            <label class="flex items-center cursor-pointer mb-1.5">
                                <input type="checkbox" id="enable-tab-colors" class="mr-2">
                                <span>탭별 색상 커스터마이징 활성화 (소설/코코포리아에만 사용 권장)</span>
                            </label>
                            <p class="label-description mb-3">각 탭의 텍스트 색상과 배경색을 개별적으로 설정할 수 있습니다</p>
                            <div id="tab-color-picker" class="space-y-2 hidden">
                                <!-- JavaScript가 동적으로 채움 -->
                            </div>
                        </div>
                            </div>
                        </div>

                        <!-- 분할 옵션 -->
                        <div id="output-options">
                            <label class="block mb-2">✂️ 파일 분할 옵션</label>
                            <div class="space-y-2.5">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" id="split-none" name="split-method" value="none" class="mr-2" checked>
                                    <span>분할 안 함</span>
                                </label>
                                <div class="flex items-center">
                                    <input type="radio" id="split-count" name="split-method" value="count" class="mr-2">
                                    <label for="split-count" class="mr-2 cursor-pointer">로그 개수로 분할:</label>
                                    <input type="number" id="log-limit-count" min="1" value="100" class="w-24" disabled>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="split-size" name="split-method" value="size" class="mr-2">
                                    <label for="split-size" class="mr-2 cursor-pointer">용량으로 분할 (KB):</label>
                                    <input type="number" id="log-limit-size" min="1" value="100" class="w-24" disabled>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="split-files" name="split-method" value="files" class="mr-2">
                                    <label for="split-files" class="mr-2 cursor-pointer">파일 개수로 분할:</label>
                                    <input type="number" id="log-limit-files" min="2" value="2" class="w-24" disabled>
                                    <span class="ml-2 text-sm text-muted">개</span>
                                </div>
                            </div>
                        </div>

                        <!-- 프리셋 관리 -->
                        <div>
                            <label class="block mb-2">💾 설정 프리셋 관리</label>
                            <p class="label-description mb-3">현재 설정을 파일로 저장하거나 불러올 수 있습니다.</p>
                            <div class="flex gap-2">
                                <button id="export-preset-btn" class="flex-1 px-4 py-2 bg-blue-900 hover:bg-blue-800 text-blue-200 text-sm rounded border border-blue-700 transition-colors">
                                    📤 설정 내보내기
                                </button>
                                <label for="import-preset-input" class="flex-1 px-4 py-2 bg-green-900 hover:bg-green-800 text-green-200 text-sm rounded border border-green-700 transition-colors cursor-pointer text-center">
                                    📥 설정 가져오기
                                </label>
                                <input type="file" id="import-preset-input" accept=".json" class="hidden">
                            </div>
                        </div>

                        <!-- 설정 초기화 -->
                        <div>
                            <label class="block mb-2">🔄 설정 초기화</label>
                            <p class="label-description mb-3">모든 설정을 기본값으로 되돌립니다.</p>
                            <button id="reset-settings-btn" class="w-full px-4 py-2 bg-red-900 hover:bg-red-800 text-red-200 text-sm rounded border border-red-700 transition-colors">
                                ⚠️ 모든 설정 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 변환 버튼 -->
            <div class="text-center py-6">
                <button id="convertBtn" class="btn-primary">
                    🎬 변환하기
                </button>
            </div>

            <!-- 결과 미리보기 -->
            <section id="result" class="hidden card p-4">
                <h2 class="section-header">결과 미리보기</h2>
                <div id="status" class="mb-3"></div>
                <div class="rounded-lg overflow-hidden" style="height: 500px;">
                    <iframe id="preview-frame" class="w-full h-full opacity-0 transition-opacity duration-300" sandbox></iframe>
                </div>
                <div id="download-container" class="mt-4 text-center flex flex-wrap gap-2 justify-center">
                    <!-- 다운로드 버튼들 -->
                </div>
            </section>
        </main>

        <!-- 푸터 -->
        <footer class="text-center mt-8 pb-6 text-gray-500 text-sm">
            <p>만두 좀 드셔보실 분 | Judgment </p>
            <p class="mt-2">Made by <a href="https://x.com/EonType00" target="_blank" class="!text-gray-400 hover:!text-violet-400">@EonType00</a></p>
        </footer>
    </div>

    <!-- 디버그 콘솔 -->
    <div id="debug-console-container" class="fixed bottom-0 right-4 z-50" style="max-width: 500px;">
        <!-- 토글 버튼 -->
        <button id="debug-toggle-btn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-200 text-sm rounded-t border border-gray-600 border-b-0 transition-colors flex items-center gap-2">
            <span>🐛 디버그 콘솔</span>
            <span id="debug-error-badge" class="hidden px-2 py-0.5 bg-red-600 text-white text-xs rounded-full">0</span>
        </button>

        <!-- 콘솔 창 -->
        <div id="debug-console" class="hidden bg-gray-900 border border-gray-600 rounded-t shadow-lg" style="max-height: 400px; min-width: 500px;">
            <!-- 헤더 -->
            <div class="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-gray-600">
                <span class="text-sm font-semibold text-gray-200">콘솔 로그</span>
                <div class="flex gap-2">
                    <button id="debug-copy-btn" class="px-2 py-1 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded transition-colors">
                        📋 복사
                    </button>
                    <button id="debug-clear-btn" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-200 text-xs rounded transition-colors">
                        🗑️ 지우기
                    </button>
                </div>
            </div>

            <!-- 로그 영역 -->
            <div id="debug-logs" class="p-3 overflow-y-auto text-xs font-mono text-gray-300 space-y-1" style="max-height: 350px; min-height: 200px;">
                <div class="text-gray-500">콘솔 로그가 여기에 표시됩니다...</div>
            </div>
        </div>
    </div>

    <script>


function extractTabs(rawHtml) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHtml, 'text/html');
    
    const logEntries = doc.querySelectorAll('p, div');
    const tabs = new Set();

    logEntries.forEach(entry => {
        const spans = entry.querySelectorAll('span');
        if (spans.length >= 3) {
            const tab = spans[0].textContent.trim().replace(/\[|\]/g, '');
            if (tab) {
                tabs.add(tab);
            }
        }
    });

    return Array.from(tabs);
}

function parseCocLog(rawHtml, narratorName = 'GM', oocTabName = '') {
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHtml, 'text/html');
    
    const logEntries = doc.querySelectorAll('p, div');
    const parsedLogs = [];

    logEntries.forEach(entry => {
        const spans = entry.querySelectorAll('span');
        if (spans.length >= 3) {
            const tab = spans[0].textContent.trim().replace(/\[|\]/g, '');
            const speaker = spans[1].textContent.trim();
            const message = spans[2].innerHTML.trim();
            let type = 'DIALOGUE';

            if (oocTabName && tab === oocTabName) type = 'OOC';
            else if (speaker === narratorName) type = 'NARRATION';
            else if (speaker === 'system' || /cc<=|1d100|1d10/i.test(message)) type = 'SYSTEM';

            parsedLogs.push({ tab, speaker, message, type });
        }
    });

    return parsedLogs;
}



class BaseGenerator {
    constructor() {
        this.colors = ['#d9480f', '#1c7ed6', '#2b6777', '#862e9c', '#5c940d'];
    }

    generateChunks(allLogs, fileName, profileImages, splitMethod, splitValue, customOptions = {}) {
        if (splitMethod === 'none' || !splitValue || splitValue <= 0) {
            return [this.buildChunk(allLogs, fileName, profileImages, 1, 1, customOptions)];
        }

        let logChunks = [];
        if (splitMethod === 'count') {
            for (let i = 0; i < allLogs.length; i += splitValue) {
                logChunks.push(allLogs.slice(i, i + splitValue));
            }
        } else if (splitMethod === 'size') {
            let currentChunkLogs = [];
            const sizeLimitBytes = splitValue * 1024;
            for (const log of allLogs) {
                currentChunkLogs.push(log);
                const tempHtml = this.buildChunk(currentChunkLogs, fileName, profileImages, 0, 0, customOptions);
                if (new Blob([tempHtml]).size > sizeLimitBytes && currentChunkLogs.length > 1) {
                    logChunks.push(currentChunkLogs.slice(0, -1));
                    currentChunkLogs = [log];
                }
            }
            if (currentChunkLogs.length > 0) logChunks.push(currentChunkLogs);
        } else if (splitMethod === 'files') {
            
            const fileCount = splitValue;
            const logsPerFile = Math.ceil(allLogs.length / fileCount);
            for (let i = 0; i < fileCount; i++) {
                const start = i * logsPerFile;
                const end = Math.min(start + logsPerFile, allLogs.length);
                if (start < allLogs.length) {
                    logChunks.push(allLogs.slice(start, end));
                }
            }
        }

        const totalParts = logChunks.length || 1;
        if(logChunks.length === 0 && allLogs.length > 0) {
            logChunks.push(allLogs);
        }

        return logChunks.map((logs, index) => this.buildChunk(logs, fileName, profileImages, index + 1, totalParts, customOptions));
    }

    extractMetadata(fileName, customOptions = {}) {
        const titleMatch = fileName.match(/\]\s*(.*?)\s*\[/);
        const extractedTitle = titleMatch ? titleMatch[1] : '세션 로그';
        const participantsMatch = fileName.match(/\[(.*?)\]/);
        const extractedParticipants = participantsMatch ? participantsMatch[1] : '참가자 정보 없음';

        const title = customOptions.title || extractedTitle;
        const participants = customOptions.subtitle || null;
        const summary = customOptions.summary || null;

        return { title, participants, summary };
    }

    createSpeakerColorMap(speakers, useClassNames = true, customColors = null) {
        const speakerColorMap = {};
        speakers.forEach((speaker, index) => {
            if (useClassNames) {
                speakerColorMap[speaker] = `speaker-color-${(index % 5) + 1}`;
            } else {
                const color = customColors?.[speaker] || this.colors[index % this.colors.length];
                speakerColorMap[speaker] = `color: ${color};`;
            }
        });
        return speakerColorMap;
    }

    buildChunk(logs, fileName, profileImages, partNum, totalParts, customOptions = {}) {
        throw new Error('buildChunk must be implemented by subclass');
    }

    buildFontImport(customOptions = {}) {
        if (customOptions.fontUrl) {
            const fontUrl = customOptions.fontUrl.trim();
            
            if (fontUrl.startsWith('@font-face')) {
                return fontUrl;
            } else if (fontUrl.startsWith('@import')) {
                return fontUrl;
            } else {
                return `@import url('${fontUrl}');`;
            }
        }
        return '';
    }

    buildFontFamily(customOptions = {}, defaultFont) {
        if (customOptions.fontFamily) {
            return `'${customOptions.fontFamily}',${defaultFont}`;
        }
        return defaultFont;
    }
}





class NovelGenerator extends BaseGenerator {
    buildChunk(logs, fileName, profileImages, partNum = 1, totalParts = 1, customOptions = {}) {
        const { title, participants, summary } = this.extractMetadata(fileName, customOptions);
        const speakers = [...new Set(logs.map(log => log.speaker))];
        const hasCustomColors = customOptions.characterColors && Object.keys(customOptions.characterColors).length > 0;
        const speakerColorMap = this.createSpeakerColorMap(speakers, !hasCustomColors, customOptions.characterColors);

        const maxNameLength = speakers.length > 0 ? Math.max(...speakers.map(s => s.length)) : 5;

        let bodyContent = '';
        let chatBuffer = [];

        const chatMode = customOptions.chatMode || 'collapse';
        const showChatCount = customOptions.showChatCount !== false;
        const hideSystem = customOptions.hideSystem || false;

        const flushChatBuffer = () => {
            if (chatBuffer.length > 0 && chatMode !== 'hide') {
                if (chatMode === 'collapse') {
                    const summaryText = showChatCount ? `잡담 메시지 (${chatBuffer.length}개)` : '';
                    bodyContent += `<div class="collapsible-note"><details><summary>${summaryText}</summary><div class="note-content">${chatBuffer.map(log => `<p><b>${log.speaker}:</b> ${log.message}</p>`).join('')}</div></details></div>`;
                } else if (chatMode === 'show') {
                    bodyContent += `<div class="chat-visible">${chatBuffer.map(log => `<p><b>${log.speaker}:</b> ${log.message}</p>`).join('')}</div>`;
                }
                chatBuffer = [];
            }
        };

        
        const subNarrators = customOptions.subNarrators || [];

        
        const tabColors = customOptions.tabColors || {};
        const enableTabColors = customOptions.enableTabColors || false;

        let currentTab = null;
        let currentTabBgColor = null;
        let tabSectionOpen = false;

        const closeTabSection = () => {
            if (tabSectionOpen) {
                bodyContent += `</div>`;
                tabSectionOpen = false;
            }
        };

        const openTabSection = (tab) => {
            if (enableTabColors && tabColors[tab] && tabColors[tab].bgColor && tabColors[tab].bgColor !== 'transparent') {
                const bgColor = tabColors[tab].bgColor;
                bodyContent += `<div class="tab-section" style="background-color: ${bgColor}; padding: 1em; border-radius: 6px; margin: 1em 0;">`;
                tabSectionOpen = true;
                currentTabBgColor = bgColor;
            }
        };

        logs.forEach(log => {
            
            if (log.type === 'SYSTEM') {
                closeTabSection();
                currentTab = null;
                if (!hideSystem) {
                    const speakerDisplay = log.speaker && log.speaker !== 'system' ? log.speaker : '시스템';
                    bodyContent += `<div class="dice-box"><div class="dice-box-header"><svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg><span>${speakerDisplay}</span></div><div class="dice-box-content">${log.message}</div></div>`;
                }
                return;
            }

            
            if (log.type === 'OOC') {
                closeTabSection();
                currentTab = null;
                chatBuffer.push(log);
                return;
            }

            flushChatBuffer();

            
            if (log.tab !== currentTab) {
                closeTabSection();
                currentTab = log.tab;
                openTabSection(log.tab);
            }

            if (log.message.includes('***')) {
                bodyContent += `<div class="scene-divider">***</div>`;
            } else if (log.type === 'NARRATION') {
                bodyContent += `<div class="narration-block">${log.message}</div>`;
            } else {
                
                const subNarratorConfig = subNarrators.find(n => n.speaker === log.speaker);

                if (subNarratorConfig) {
                    
                    switch (subNarratorConfig.style) {
                        case 'italic-narration':
                            bodyContent += `<div class="narration-block narration-block-italic">${log.message}</div>`;
                            break;
                        case 'normal-narration':
                            bodyContent += `<div class="narration-block">${log.message}</div>`;
                            break;
                        case 'italic-dialogue':
                            const colorValue = speakerColorMap[log.speaker] || '';
                            const messageLines = log.message.split('|||');
                            const allLines = messageLines.map(line => `<div style="font-style:italic;">${line}</div>`).join('');
                            if (hasCustomColors) {
                                bodyContent += `<div class="dialogue-block-grid"><span class="speaker-name-grid" style="${colorValue}">${log.speaker}</span><div class="message-lines-grid">${allLines}</div></div>`;
                            } else {
                                bodyContent += `<div class="dialogue-block-grid ${colorValue}"><span class="speaker-name-grid">${log.speaker}</span><div class="message-lines-grid">${allLines}</div></div>`;
                            }
                            break;
                        case 'colored-narration':
                            const customColor = subNarratorConfig.color || '#9ca3af';
                            bodyContent += `<div class="narration-block" style="color:${customColor};">${log.message}</div>`;
                            break;
                        default:
                            bodyContent += `<div class="narration-block">${log.message}</div>`;
                    }
                } else {
                    
                    const colorValue = speakerColorMap[log.speaker] || '';
                    const messageLines = log.message.split('|||');

                    const allLines = messageLines.map(line => `<div>${line}</div>`).join('');

                    
                    if (hasCustomColors) {
                        bodyContent += `<div class="dialogue-block-grid"><span class="speaker-name-grid" style="${colorValue}">${log.speaker}</span><div class="message-lines-grid">${allLines}</div></div>`;
                    } else {
                        bodyContent += `<div class="dialogue-block-grid ${colorValue}"><span class="speaker-name-grid">${log.speaker}</span><div class="message-lines-grid">${allLines}</div></div>`;
                    }
                }
            }
        });
        closeTabSection();
        flushChatBuffer();

        const partTitle = totalParts > 1 ? `${title} (Part ${partNum})` : title;
        const headerTitle = totalParts > 1 ? `${title} #${partNum}`: title;
        const footerIndicator = totalParts > 1 ? `<footer class="page-footer">Page ${partNum} of ${totalParts}</footer>` : '';

        const customFontImport = this.buildFontImport(customOptions);
        const defaultFontImport = customFontImport || `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR:wght@400;700&display=swap');`;
        const fontMain = this.buildFontFamily(customOptions, `'Noto Sans KR',sans-serif`);
        const fontSerif = this.buildFontFamily(customOptions, `'Noto Serif KR',serif`);

        
        const fontSize = customOptions.fontSize || '17';
        const lineHeight = customOptions.lineHeight || '1.8';
        const pageWidth = customOptions.pageWidth || '750';

        
        const systemBgColor = customOptions.systemBgColor || '#2a0a0a';
        const systemBorderColor = customOptions.systemBorderColor || '#7f1d1d';
        const systemTextColor = customOptions.systemTextColor || '#1a1a1a';

        
        const themeBgColor = customOptions.themeBgColor || '#0a0a0a';
        const themeContainerColor = customOptions.themeContainerColor || '#1e1e1e';
        const themeTextColor = customOptions.themeTextColor || '#e5e7eb';
        const themeAccentColor = customOptions.themeAccentColor || '#7f1d1d';

        const summaryHtml = summary ? `<p class="summary">${summary}</p>` : '';
        const participantsHtml = participants ? `<p class="participants">${participants}</p>` : '';
        const gridColumnWidth = `${maxNameLength}em`;

        
        const typographyStyles = customOptions.novelTypography
            ? `.narration-block{text-indent:1em;letter-spacing:-0.01em;word-spacing:0.05em;}.dialogue-block-grid .message-lines-grid>div{letter-spacing:-0.01em;word-spacing:0.05em;}`
            : '';

        return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${partTitle}</title><style>${defaultFontImport}:root{--bg-color:${themeBgColor};--main-text-color:${themeTextColor};--secondary-text-color:#9ca3af;--border-color:${themeAccentColor};--system-bg-color:${systemBgColor};--system-border-color:${systemBorderColor};--system-text-color:${systemTextColor};--font-main:${fontMain};--font-serif:${fontSerif};}body{font-family:var(--font-serif);background:${themeBgColor};color:var(--main-text-color);margin:0;padding:20px;font-size:${fontSize}px;line-height:${lineHeight};}.log-container{max-width:${pageWidth}px;margin:40px auto;background-color:${themeContainerColor};border:1px solid var(--border-color);box-shadow:0 8px 32px rgba(127,29,29,0.4);padding:50px 60px;}.header{text-align:center;border-bottom:2px solid var(--border-color);padding-bottom:20px;margin-bottom:50px;}.header h1{font-family:var(--font-serif);font-size:2.5em;font-weight:700;margin:0;}.header .participants{font-family:var(--font-main);font-size:1.1em;color:var(--secondary-text-color);margin-top:15px;}.header .summary{font-family:var(--font-main);font-size:0.95em;color:var(--secondary-text-color);margin-top:15px;line-height:1.6;}.narration-block{margin-bottom:1.5em;}.narration-block-italic{font-style:italic;}.dialogue-block{margin:0.8em 0;}.dialogue-block .speaker-name{font-weight:700;display:inline;}.dialogue-block .message-container{display:inline;}.dialogue-block .msg-line.first-line{display:inline;}.dialogue-block .msg-line{display:block;}.dialogue-block-grid{display:grid;grid-template-columns:${gridColumnWidth} 1fr;margin:0.8em 0;column-gap:0.5em;}.dialogue-block-grid .speaker-name-grid{font-weight:700;white-space:nowrap;align-self:start;text-align:right;}.dialogue-block-grid .message-lines-grid{align-self:start;}.dialogue-block-grid .message-lines-grid>div{margin:0;}.speaker-color-1 .speaker-name,.speaker-color-1 .speaker-name-grid{color:#d9480f;}.speaker-color-2 .speaker-name,.speaker-color-2 .speaker-name-grid{color:#1c7ed6;}.speaker-color-3 .speaker-name,.speaker-color-3 .speaker-name-grid{color:#2b6777;}.speaker-color-4 .speaker-name,.speaker-color-4 .speaker-name-grid{color:#862e9c;}.speaker-color-5 .speaker-name,.speaker-color-5 .speaker-name-grid{color:#5c940d;}.scene-divider{text-align:center;margin:3em 0;color:var(--secondary-text-color);letter-spacing:0.5em;}.dice-box{margin:1em 0;padding:10px 14px;background-color:var(--system-bg-color);border:2px solid var(--system-border-color);border-radius:6px;font-family:var(--font-main);font-size:0.95em;}.dice-box-header{font-weight:700;color:var(--system-text-color);margin-bottom:6px;}.dice-box-content{color:var(--system-text-color);line-height:1.5;}.system-message{margin:1em 0;padding:8px 12px;background-color:var(--system-bg-color);border-left:3px solid var(--system-border-color);font-family:var(--font-main);font-size:0.9em;color:var(--system-text-color);}.system-message p{margin:0;}.collapsible-note{margin:2em 0;font-family:var(--font-main);}.collapsible-note details{border:1px dashed var(--border-color);border-radius:4px;background-color:#2a2a2a;font-size:0.9em;}.collapsible-note summary{padding:8px 12px;color:var(--secondary-text-color);font-weight:bold;cursor:pointer;}.collapsible-note .note-content{padding:0 12px 12px;color:var(--secondary-text-color);white-space:pre-wrap;}.collapsible-note .note-content p{margin:0 0 5px;}.chat-visible{margin:2em 0;padding:10px;border:1px dashed var(--border-color);background-color:#2a2a2a;font-family:var(--font-main);font-size:0.9em;color:var(--secondary-text-color);}.chat-visible p{margin:0 0 5px;}.page-footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid var(--border-color);font-family:var(--font-main);color:var(--secondary-text-color);font-size:0.9em;}${typographyStyles}</style></head><body><div class="log-container"><header class="header"><h1>${headerTitle}</h1>${participantsHtml}${summaryHtml}</header>${bodyContent}${footerIndicator}</div></body></html>`;
    }
}





class TimelineGenerator extends BaseGenerator {
    buildChunk(logs, fileName, profileImages, partNum = 1, totalParts = 1, customOptions = {}) {
        const { title, participants, summary } = this.extractMetadata(fileName, customOptions);
        
        const speakers = [...new Set(logs.filter(log => log.type === 'DIALOGUE' && log.speaker).map(log => log.speaker))];
        const speakerColorMap = this.createSpeakerColorMap(speakers, false, customOptions.characterColors);

        
        const getVisibleLength = (str) => str.replace(/\s/g, '').length;
        const maxVisibleLength = speakers.length > 0 ? Math.max(...speakers.map(s => getVisibleLength(s))) : 5;

        
        const speakerLetterSpacing = {};
        speakers.forEach(speaker => {
            const visibleLength = getVisibleLength(speaker);
            if (visibleLength < maxVisibleLength && visibleLength > 0) {
                const diff = maxVisibleLength - visibleLength;
                
                const spacing = diff / visibleLength;
                speakerLetterSpacing[speaker] = `letter-spacing:${spacing.toFixed(3)}em;`;
            } else {
                speakerLetterSpacing[speaker] = '';
            }
        });

        const maxNameLength = speakers.length > 0 ? Math.max(...speakers.map(s => s.length)) : 5;

        let bodyContent = '';
        let chatBuffer = [];
        let narrationBuffer = [];
        let narrationBufferTab = null;

        const chatMode = customOptions.chatMode || 'collapse';
        const showChatCount = customOptions.showChatCount !== false;
        const hideSystem = customOptions.hideSystem || false;
        const subNarrators = customOptions.subNarrators || [];

        
        const tabColors = customOptions.tabColors || {};
        const enableTabColors = customOptions.enableTabColors || false;

        
        const themeBgColor = customOptions.themeBgColor || '#0a0a0a';
        const themeContainerColor = customOptions.themeContainerColor || '#1e1e1e';
        const themeTextColor = customOptions.themeTextColor || '#e5e7eb';
        const themeAccentColor = customOptions.themeAccentColor || '#7f1d1d';

        
        const systemBgColor = customOptions.systemBgColor || '#2a0a0a';
        const systemBorderColor = customOptions.systemBorderColor || '#7f1d1d';
        const systemTextColor = customOptions.systemTextColor || '#1a1a1a';

        
        const narrationBgColor = customOptions.narrationBgColor || '#2a2a2a';
        const narrationTextColor = customOptions.narrationTextColor || '#9ca3af';

        const flushChatBuffer = () => {
            if (chatBuffer.length > 0 && chatMode !== 'hide') {
                if (chatMode === 'collapse') {
                    const summaryText = showChatCount ? `잡담 메시지 (${chatBuffer.length}개)` : '';
                    bodyContent += `<div class="timeline-entry chat-fold"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div><div class="timeline-content"><details><summary>${summaryText}</summary><div class="chat-content">${chatBuffer.map(log => `<p><b style="${speakerColorMap[log.speaker] || ''}">${log.speaker}:</b> ${log.message}</p>`).join('')}</div></details></div></div>`;
                } else if (chatMode === 'show') {
                    chatBuffer.forEach(log => {
                        bodyContent += `<div class="timeline-entry chat-visible"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div><div class="timeline-content"><p><b style="${speakerColorMap[log.speaker] || ''}">${log.speaker}:</b> ${log.message}</p></div></div>`;
                    });
                }
                chatBuffer = [];
            }
        };

        const flushNarrationBuffer = () => {
            if (narrationBuffer.length > 0) {
                
                let narrationBgStyle = '';
                if (enableTabColors && narrationBufferTab && tabColors[narrationBufferTab] && tabColors[narrationBufferTab].bgColor && tabColors[narrationBufferTab].bgColor !== 'transparent') {
                    narrationBgStyle = ` style="background-color: ${tabColors[narrationBufferTab].bgColor} !important; padding: 0.8em; border-radius: 6px;"`;
                } else {
                    
                    narrationBgStyle = ` style="background-color: ${narrationBgColor} !important; padding: 10px; border-radius: 6px; color: ${narrationTextColor} !important;"`;
                }

                bodyContent += `<div class="timeline-entry narration"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/></svg></div><div class="timeline-content"${narrationBgStyle}>`;
                narrationBuffer.forEach(msg => {
                    bodyContent += `<p class="message">${msg}</p>`;
                });
                bodyContent += `</div></div>`;
                narrationBuffer = [];
                narrationBufferTab = null;
            }
        };

        logs.forEach(log => {
            
            if (log.type === 'SYSTEM') {
                flushNarrationBuffer(); // 나레이션 버퍼 비우기
                flushChatBuffer(); // 잡담 버퍼 비우기

                if (!hideSystem) {
                    const speakerDisplay = log.speaker && log.speaker !== 'system' ? log.speaker : '시스템';
                    const iconHtml = `<div class="timeline-icon dice-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg></div>`;
                    bodyContent += `<div class="timeline-entry system">${iconHtml}<div class="timeline-content"><div class="dice-box-inline"><div class="dice-box-header">${speakerDisplay}</div><div class="dice-box-content">${log.message}</div></div></div></div>`;
                }
                return;
            }

            
            if (log.type === 'OOC') {
                flushNarrationBuffer(); // 나레이션을 먼저 출력
                chatBuffer.push(log);
                return;
            }

            
            let contentBgStyle = '';
            if (enableTabColors && tabColors[log.tab] && tabColors[log.tab].bgColor && tabColors[log.tab].bgColor !== 'transparent') {
                contentBgStyle = ` style="background-color: ${tabColors[log.tab].bgColor} !important; padding: 0.8em; border-radius: 6px;"`;
            } else {
                
                contentBgStyle = ` style="background-color: ${themeContainerColor} !important; padding: 0.8em; border-radius: 6px;"`;
            }

            
            if (log.type === 'NARRATION') {
                flushChatBuffer(); // 잡담을 먼저 출력
                
                if (narrationBuffer.length === 0) {
                    narrationBufferTab = log.tab;
                }
                narrationBuffer.push(log.message);
            } else {
                
                const subNarratorConfig = subNarrators.find(n => n.speaker === log.speaker);

                if (subNarratorConfig) {
                    
                    flushChatBuffer();

                    switch (subNarratorConfig.style) {
                        case 'italic-narration':
                            bodyContent += `<div class="timeline-entry narration"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/></svg></div><div class="timeline-content"${contentBgStyle}><p class="message" style="font-style:italic;">${log.message}</p></div></div>`;
                            break;
                        case 'normal-narration':
                            bodyContent += `<div class="timeline-entry narration"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/></svg></div><div class="timeline-content"${contentBgStyle}><p class="message">${log.message}</p></div></div>`;
                            break;
                        case 'colored-narration':
                            const customColor = subNarratorConfig.color || '#9ca3af';
                            bodyContent += `<div class="timeline-entry narration"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/></svg></div><div class="timeline-content"${contentBgStyle}><p class="message" style="color:${customColor};">${log.message}</p></div></div>`;
                            break;
                        case 'italic-dialogue':
                            flushNarrationBuffer();
                            const profileImgSrc1 = profileImages[log.speaker];
                            const iconHtml1 = profileImgSrc1
                                ? `<div class="timeline-icon"><img src="${profileImgSrc1}" class="profile-image"></div>`
                                : `<div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:24px;height:24px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>`;
                            const messageLines1 = log.message.split('|||');
                            const speakerStyle1 = `${speakerColorMap[log.speaker] || ''}${speakerLetterSpacing[log.speaker] || ''}`;
                            bodyContent += `<div class="timeline-entry dialogue">${iconHtml1}<div class="timeline-content"${contentBgStyle}><div class="speaker-message-grid"><span class="speaker-name" style="${speakerStyle1}">${log.speaker}</span><div class="message-lines">`;
                            messageLines1.forEach(line => {
                                bodyContent += `<div style="font-style:italic;">${line}</div>`;
                            });
                            bodyContent += `</div></div></div></div>`;
                            break;
                        default:
                            bodyContent += `<div class="timeline-entry narration"><div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z"/></svg></div><div class="timeline-content"${contentBgStyle}><p class="message">${log.message}</p></div></div>`;
                    }
                } else {
                    
                    flushNarrationBuffer(); // 나레이션 버퍼 비우기
                    flushChatBuffer(); // 잡담 버퍼 비우기

                    const profileImgSrc = profileImages[log.speaker];
                    const iconHtml = profileImgSrc
                        ? `<div class="timeline-icon"><img src="${profileImgSrc}" class="profile-image"></div>`
                        : `<div class="timeline-icon"><svg viewBox="0 0 24 24" fill="currentColor" style="width:24px;height:24px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>`;

                    const messageLines = log.message.split('|||');

                    
                    const speakerStyle = `${speakerColorMap[log.speaker] || ''}${speakerLetterSpacing[log.speaker] || ''}`;
                    bodyContent += `<div class="timeline-entry dialogue">${iconHtml}<div class="timeline-content"${contentBgStyle}><div class="speaker-message-grid"><span class="speaker-name" style="${speakerStyle}">${log.speaker}</span><div class="message-lines">`;
                    messageLines.forEach(line => {
                        bodyContent += `<div>${line}</div>`;
                    });
                    bodyContent += `</div></div></div></div>`;
                }
            }
        });
        flushChatBuffer();
        flushNarrationBuffer();

        const partTitle = totalParts > 1 ? `${title} (Part ${partNum})` : title;
        const headerTitle = totalParts > 1 ? `${title} #${partNum}`: title;
        const footerIndicator = totalParts > 1 ? `<footer class="page-footer">Page ${partNum} of ${totalParts}</footer>` : '';

        const customFontImport = this.buildFontImport(customOptions);
        const defaultFontImport = customFontImport || `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Noto+Serif+KR:wght@400;600&display=swap');`;
        const fontMain = this.buildFontFamily(customOptions, `'Noto Sans KR',sans-serif`);
        const fontSerif = this.buildFontFamily(customOptions, `'Noto Serif KR',serif`);

        
        const fontSize = customOptions.fontSize || '17';
        const lineHeight = customOptions.lineHeight || '1.8';
        const pageWidth = customOptions.pageWidth || '800';

        const summaryHtml = summary ? `<p class="summary">${summary}</p>` : '';
        const participantsHtml = participants ? `<p class="participants">${participants}</p>` : '';
        const gridColumnWidth = `${maxNameLength}em`;

        return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${partTitle}</title><style>${defaultFontImport}#ccfolia-timeline-wrap{font-family:${fontMain}!important;background:${themeBgColor}!important;color:${themeTextColor}!important;margin:0!important;padding:20px!important;font-size:${fontSize}px!important;}#ccfolia-timeline-wrap .log-container{max-width:${pageWidth}px!important;margin:40px auto!important;background-color:${themeContainerColor}!important;border-radius:12px!important;box-shadow:0 8px 32px rgba(127,29,29,0.4)!important;padding:30px 40px!important;}#ccfolia-timeline-wrap .header{text-align:center!important;border-bottom:1px solid ${themeAccentColor}!important;padding-bottom:20px!important;margin-bottom:40px!important;}#ccfolia-timeline-wrap .header h1{font-family:${fontSerif}!important;font-size:2.2em!important;margin:0!important;color:${themeTextColor}!important;}#ccfolia-timeline-wrap .header .participants{font-size:1.1em!important;color:#9ca3af!important;margin-top:10px!important;}#ccfolia-timeline-wrap .header .summary{font-size:0.95em!important;color:#9ca3af!important;margin-top:15px!important;line-height:1.6!important;}#ccfolia-timeline-wrap .timeline{position:relative!important;padding:20px 0!important;}#ccfolia-timeline-wrap .timeline::before{content:''!important;position:absolute!important;left:20px!important;top:0!important;bottom:0!important;width:2px!important;background-color:${themeAccentColor}!important;}#ccfolia-timeline-wrap .timeline-entry{position:relative!important;padding:5px 0 25px 55px!important;}#ccfolia-timeline-wrap .timeline-icon{position:absolute!important;left:0!important;top:5px!important;width:40px!important;height:40px!important;border-radius:50%!important;background-color:${themeBgColor}!important;border:2px solid ${themeAccentColor}!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:1.2em!important;color:#9ca3af!important;overflow:hidden!important;}#ccfolia-timeline-wrap .timeline-icon.dice-icon{color:${systemTextColor}!important;border-color:${systemBorderColor}!important;background-color:${systemBgColor}!important;}#ccfolia-timeline-wrap .timeline-icon img.profile-image{width:100%!important;height:100%!important;object-fit:cover!important;object-position:top!important;}#ccfolia-timeline-wrap .timeline-entry.system .timeline-content .message{color:${systemTextColor}!important;}#ccfolia-timeline-wrap .timeline-content{position:relative!important;}#ccfolia-timeline-wrap .timeline-content .speaker-message{display:flex!important;align-items:baseline!important;}#ccfolia-timeline-wrap .timeline-content .speaker-message-grid{display:grid!important;grid-template-columns:${gridColumnWidth} 1fr!important;column-gap:0.5em!important;}#ccfolia-timeline-wrap .timeline-content .speaker-message-grid .speaker-name{text-align:right!important;}#ccfolia-timeline-wrap .timeline-content .speaker-message-grid .message-lines{align-self:start!important;}#ccfolia-timeline-wrap .timeline-content .speaker-message-grid .message-lines>div{margin:0!important;}#ccfolia-timeline-wrap .timeline-content .speaker-name{font-weight:700!important;flex-shrink:0!important;white-space:nowrap!important;}#ccfolia-timeline-wrap .timeline-content .message{line-height:${lineHeight}!important;margin:0!important;flex:1!important;}#ccfolia-timeline-wrap .timeline-content .msg-line.first-line{display:inline!important;}#ccfolia-timeline-wrap .timeline-content .msg-line{display:block!important;}#ccfolia-timeline-wrap .narration .timeline-content{font-family:${fontSerif}!important;color:${narrationTextColor}!important;padding:10px!important;background-color:${narrationBgColor}!important;border-radius:6px!important;}#ccfolia-timeline-wrap .narration .timeline-icon{color:#9ca3af!important;}#ccfolia-timeline-wrap .chat-fold details{border:none!important;border-left:3px solid ${themeAccentColor}!important;padding-left:10px!important;}#ccfolia-timeline-wrap .chat-fold summary{font-weight:bold!important;color:#9ca3af!important;cursor:pointer!important;padding:5px 0!important;}#ccfolia-timeline-wrap .chat-fold .chat-content{padding:10px 0 0 0!important;font-size:0.9em!important;color:#9ca3af!important;}#ccfolia-timeline-wrap .chat-fold .chat-content p{margin:0 0 5px!important;}#ccfolia-timeline-wrap .chat-fold .timeline-icon{color:#adb5bd!important;}#ccfolia-timeline-wrap .dice-box{margin:1em 0!important;padding:10px 14px!important;background-color:${systemBgColor}!important;border:2px solid ${systemBorderColor}!important;border-radius:6px!important;font-family:${fontMain}!important;font-size:0.95em!important;}#ccfolia-timeline-wrap .dice-box-inline{padding:10px 14px!important;background-color:${systemBgColor}!important;border:2px solid ${systemBorderColor}!important;border-radius:6px!important;font-family:${fontMain}!important;font-size:0.95em!important;}#ccfolia-timeline-wrap .dice-box-header{font-weight:700!important;color:${systemTextColor}!important;margin-bottom:6px!important;}#ccfolia-timeline-wrap .dice-box-content{color:${systemTextColor}!important;line-height:1.5!important;}#ccfolia-timeline-wrap .page-footer{text-align:center!important;margin-top:30px!important;padding-top:20px!important;border-top:1px solid ${themeAccentColor}!important;font-family:${fontMain}!important;color:#9ca3af!important;font-size:0.9em!important;}</style></head><body><div id="ccfolia-timeline-wrap"><div class="log-container"><header class="header"><h1>${headerTitle}</h1>${participantsHtml}${summaryHtml}</header><div class="timeline">${bodyContent}</div>${footerIndicator}</div></div></body></html>`;
    }
}





class ReportGenerator extends BaseGenerator {
    buildChunk(logs, fileName, profileImages, partNum = 1, totalParts = 1, customOptions = {}) {
        const { title, participants } = this.extractMetadata(fileName, customOptions);
        const speakers = [...new Set(logs.map(log => log.speaker))];
        const hasCustomColors = customOptions.characterColors && Object.keys(customOptions.characterColors).length > 0;
        const speakerColorMap = this.createSpeakerColorMap(speakers, !hasCustomColors, customOptions.characterColors);

        const chatMode = customOptions.chatMode || 'collapse';
        const hideSystem = customOptions.hideSystem || false;

        let bodyContent = '';
        logs.forEach(log => {
            
            if (log.type === 'SYSTEM') {
                if (!hideSystem) {
                    const speakerDisplay = log.speaker && log.speaker !== 'system' ? log.speaker : '시스템';
                    bodyContent += `<div class="dice-box"><div class="dice-box-header"><svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg><span>${speakerDisplay}</span></div><div class="dice-box-content">${log.message}</div></div>`;
                }
                return;
            }

            
            if (log.type === 'OOC') {
                if (chatMode !== 'hide') {
                    const colorValue = speakerColorMap[log.speaker] || '';
                    if (hasCustomColors) {
                        bodyContent += `<div class="log-entry chat-note"><p><strong>[잡담]</strong> <strong style="${colorValue}">${log.speaker}:</strong> ${log.message}</p></div>`;
                    } else {
                        bodyContent += `<div class="log-entry chat-note"><p><strong>[잡담]</strong> <strong class="${colorValue}">${log.speaker}:</strong> ${log.message}</p></div>`;
                    }
                }
                return;
            }

            if (log.type === 'NARRATION') {
                bodyContent += `<div class="log-entry narration-block"><p>${log.message}</p></div>`;
            } else {
                
                const colorValue = speakerColorMap[log.speaker] || '';
                const messageLines = log.message.split('|||');
                const allLines = messageLines.map((line, index) =>
                    index === 0 ? `<div class="msg-line first-line">${line}</div>` : `<div class="msg-line">${line}</div>`
                ).join('');

                if (hasCustomColors) {
                    bodyContent += `<div class="log-entry"><span class="speaker" style="${colorValue}">${log.speaker}:</span> <div class="message">${allLines}</div></div>`;
                } else {
                    bodyContent += `<div class="log-entry"><span class="speaker ${colorValue}">${log.speaker}:</span> <div class="message">${allLines}</div></div>`;
                }
            }
        });

        const partTitle = totalParts > 1 ? `${title} (Part ${partNum})` : title;
        const footerIndicator = totalParts > 1 ? `<footer class="page-footer">Page ${partNum} of ${totalParts}</footer>` : '';
        const stampText = customOptions.stampText || 'CLASSIFIED';

        const customFontImport = this.buildFontImport(customOptions);
        const defaultFontImport = customFontImport || `@import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Nanum+Gothic+Coding:wght@400;700&display=swap');`;
        const fontTypewriter = this.buildFontFamily(customOptions, `'Nanum Gothic Coding',monospace`);
        const fontSerif = this.buildFontFamily(customOptions, `'Nanum Myeongjo',serif`);

        
        const fontSize = customOptions.fontSize || '16';
        const lineHeight = customOptions.lineHeight || '1.9';
        const pageWidth = customOptions.pageWidth || '850';

        
        const systemBgColor = customOptions.systemBgColor || '#2a0a0a';
        const systemBorderColor = customOptions.systemBorderColor || '#7f1d1d';
        const systemTextColor = customOptions.systemTextColor || '#1a1a1a';

        
        const themeBgColor = customOptions.themeBgColor || '#0a0a0a';
        const themeContainerColor = customOptions.themeContainerColor || '#1e1e1e';
        const themeTextColor = customOptions.themeTextColor || '#e5e7eb';
        const themeAccentColor = customOptions.themeAccentColor || '#7f1d1d';

        const participantsInfo = participants ? `<span><strong>SUBJECTS:</strong> ${participants}</span>` : '';

        return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>${partTitle}</title><style>${defaultFontImport}:root{--bg-color:${themeBgColor};--paper-color:${themeContainerColor};--main-text-color:${themeTextColor};--secondary-text-color:#9ca3af;--stamp-color:${themeAccentColor};--system-bg-color:${systemBgColor};--system-border-color:${systemBorderColor};--system-text-color:${systemTextColor};--font-typewriter:${fontTypewriter};--font-serif:${fontSerif};}body{font-family:var(--font-typewriter);background:${themeBgColor};color:var(--main-text-color);margin:0;padding:20px;font-size:${fontSize}px;line-height:${lineHeight};}.log-container{max-width:${pageWidth}px;margin:40px auto;background-color:var(--paper-color);box-shadow:0 8px 32px rgba(127,29,29,0.4);padding:40px 50px;border:1px solid ${themeAccentColor};}.file-header{border:2px solid var(--main-text-color);padding:15px;margin-bottom:40px;position:relative;}.file-header h1{font-family:var(--font-typewriter);font-size:1.8em;text-align:center;letter-spacing:2px;margin:0;border-bottom:1px solid var(--main-text-color);padding-bottom:10px;}.file-header .info-grid{display:grid;grid-template-columns:1fr 1fr;margin-top:10px;font-size:0.9em;gap: 5px 10px;}.file-header .stamp{position:absolute;top:-15px;left:15px;font-family:var(--font-serif);font-size:1.5em;font-weight:700;color:var(--stamp-color);border:3px solid var(--stamp-color);padding:2px 8px;transform:rotate(-10deg);}.log-entry{display:flex;align-items:baseline;margin-bottom:1.2em;}.log-entry .speaker{font-weight:700;flex-shrink:0;}.log-entry .message{flex:1;}.log-entry .msg-line.first-line{display:inline;}.log-entry .msg-line{display:block;}.speaker-color-1{color:#B71C1C;}.speaker-color-2{color:#0D47A1;}.speaker-color-3{color:#004D40;}.speaker-color-4{color:#4A148C;}.speaker-color-5{color:#33691E;}.narration-block{padding:15px;background-color:#2a2a2a;border-left:3px solid var(--stamp-color);margin:2em 0;}.narration-block p {margin: 0;}.dice-box{margin:1em 0;padding:10px 14px;background-color:var(--system-bg-color);border:2px solid var(--system-border-color);border-radius:6px;font-family:var(--font-typewriter);font-size:0.95em;}.dice-box-header{font-weight:700;color:var(--system-text-color);margin-bottom:6px;}.dice-box-content{color:var(--system-text-color);line-height:1.5;}.system-note{text-align:center;margin:2em 0;}.system-note .stamp-box{display:inline-block;border:2px solid var(--system-border-color);color:var(--system-text-color);background-color:var(--system-bg-color);padding:8px 15px;font-weight:700;font-family:var(--font-serif);}.chat-note{font-size:0.9em;color:var(--secondary-text-color);padding:10px;border:1px dashed var(--stamp-color);background-color:#2a2a2a;}.chat-note p{margin:0 0 5px;}.page-footer{text-align:center;margin:top:40px;padding-top:20px;border-top:1px solid var(--stamp-color);font-family:var(--font-typewriter);color:var(--secondary-text-color);font-size:0.9em;}</style></head><body><div class="log-container"><header class="file-header"><div class="stamp">${stampText}</div><h1>INCIDENT REPORT #${partNum}</h1><div class="info-grid"><span><strong>CASE FILE:</strong> ${title.replace(/\s/g, '_')}</span><span><strong>DATE:</strong> ${new Date().toLocaleDateString('ko-KR')}</span>${participantsInfo}<span><strong>HANDLER:</strong> GM</span></div></header>${bodyContent}${footerIndicator}</div></body></html>`;
    }
}





class OriginalGenerator extends BaseGenerator {
    buildChunk(logs, fileName, profileImages, partNum = 1, totalParts = 1, customOptions = {}) {
        const { title, participants, summary } = this.extractMetadata(fileName, customOptions);
        const speakers = [...new Set(logs.filter(log => log.type === 'DIALOGUE' && log.speaker).map(log => log.speaker))];
        const speakerColorMap = this.createSpeakerColorMap(speakers, false, customOptions.characterColors);

        const chatMode = customOptions.chatMode || 'collapse';
        const showChatCount = customOptions.showChatCount !== false;
        const hideSystem = customOptions.hideSystem || false;
        const tabStyles = customOptions.tabStyles || {};
        const tabColors = customOptions.tabColors || {};
        const enableTabColors = customOptions.enableTabColors || false;

        let bodyContent = '';
        let chatBuffer = [];

        const flushChatBuffer = () => {
            if (chatBuffer.length > 0 && chatMode !== 'hide') {
                if (chatMode === 'collapse') {
                    const summaryText = showChatCount ? `잡담 메시지 ${chatBuffer.length}개` : '잡담 메시지';
                    bodyContent += `<div class="chat-fold-container"><details><summary class="chat-fold-summary">${summaryText}</summary><div class="chat-fold-content">`;
                    chatBuffer.forEach(log => {
                        const tabStyle = tabStyles[log.tab] || 'none';
                        const tabLabel = tabStyle === 'label' && log.tab ? `<span class="tab-label">[${log.tab}]</span>` : '';
                        
                        let itemBgStyle = '';
                        if (enableTabColors && tabColors[log.tab] && tabColors[log.tab].bgColor && tabColors[log.tab].bgColor !== 'transparent') {
                            itemBgStyle = ` style="background-color: ${tabColors[log.tab].bgColor};"`;
                        }
                        const profileHtml = profileImages[log.speaker]
                            ? `<img src="${profileImages[log.speaker]}" alt="${log.speaker}">`
                            : `<svg viewBox="0 0 24 24" fill="currentColor" style="width:40px;height:40px;color:#9ca3af;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                        bodyContent += `<div class="message-item chat"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${log.message}</div></div></div>`;
                    });
                    bodyContent += `</div></details></div>`;
                } else if (chatMode === 'show') {
                    chatBuffer.forEach(log => {
                        const tabStyle = tabStyles[log.tab] || 'none';
                        const tabLabel = tabStyle === 'label' && log.tab ? `<span class="tab-label">[${log.tab}]</span>` : '';
                        
                        let itemBgStyle = '';
                        if (enableTabColors && tabColors[log.tab] && tabColors[log.tab].bgColor && tabColors[log.tab].bgColor !== 'transparent') {
                            itemBgStyle = ` style="background-color: ${tabColors[log.tab].bgColor};"`;
                        }
                        const profileHtml = profileImages[log.speaker]
                            ? `<img src="${profileImages[log.speaker]}" alt="${log.speaker}">`
                            : `<svg viewBox="0 0 24 24" fill="currentColor" style="width:40px;height:40px;color:#9ca3af;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                        bodyContent += `<div class="message-item chat"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${log.message}</div></div></div>`;
                    });
                }
                chatBuffer = [];
            }
        };

        logs.forEach(log => {
            
            const tabStyle = tabStyles[log.tab] || 'none';

            
            if (tabStyle === 'hide') {
                return;
            }

            
            if (log.type === 'SYSTEM') {
                flushChatBuffer();
                if (!hideSystem) {
                    const speakerDisplay = log.speaker && log.speaker !== 'system' ? log.speaker : '시스템';
                    bodyContent += `<div class="message-item system"><div class="profile-img"><div class="system-icon">🎲</div></div><div class="message-content"><div class="message-header"><span class="speaker-name system-name">${speakerDisplay}</span></div><div class="message-text system-text">${log.message}</div></div></div>`;
                }
                return;
            }

            
            if (log.type === 'OOC') {
                chatBuffer.push(log);
                return;
            }

            flushChatBuffer();

            
            let tabLabel = '';
            if (tabStyle === 'label' && log.tab) {
                let tabLabelStyle = '';
                if (enableTabColors && tabColors[log.tab]) {
                    const color = tabColors[log.tab].textColor || '#9ca3af';
                    tabLabelStyle = `style="color: ${color};"`;
                }
                tabLabel = `<span class="tab-label" ${tabLabelStyle}>[${log.tab}]</span>`;
            }
            

            
            let itemBgStyle = '';
            if (enableTabColors && tabColors[log.tab] && tabColors[log.tab].bgColor && tabColors[log.tab].bgColor !== 'transparent') {
                itemBgStyle = ` style="background-color: ${tabColors[log.tab].bgColor};"`;
            }

            
            if (tabStyle === 'system') {
                const speakerDisplay = log.speaker || '알림';
                bodyContent += `<div class="message-item system"><div class="profile-img"><div class="system-icon">📌</div></div><div class="message-content"><div class="message-header"><span class="speaker-name system-name">${speakerDisplay}</span></div><div class="message-text system-text">${log.message}</div></div></div>`;
                return;
            }

            
            const subNarrators = customOptions.subNarrators || [];
            const subNarratorConfig = subNarrators.find(n => n.speaker === log.speaker);

            
            if (subNarratorConfig) {
                const profileHtml = profileImages[log.speaker]
                    ? `<img src="${profileImages[log.speaker]}" alt="${log.speaker}">`
                    : `<svg viewBox="0 0 24 24" fill="currentColor" style="width:40px;height:40px;color:#fbbf24;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;

                switch (subNarratorConfig.style) {
                    case 'italic-narration':
                        bodyContent += `<div class="message-item narration"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name gm-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text narration-text">${log.message}</div></div></div>`;
                        break;
                    case 'normal-narration':
                        bodyContent += `<div class="message-item narration"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name gm-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${log.message}</div></div></div>`;
                        break;
                    case 'italic-dialogue':
                        const messageLines1 = log.message.split('|||');
                        const messageHtml1 = messageLines1.map(line => `<div style="font-style:italic;">${line}</div>`).join('');
                        bodyContent += `<div class="message-item dialogue"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${messageHtml1}</div></div></div>`;
                        break;
                    case 'colored-narration':
                        const customColor = subNarratorConfig.color || '#9ca3af';
                        bodyContent += `<div class="message-item narration"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name gm-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text" style="color:${customColor};">${log.message}</div></div></div>`;
                        break;
                    default:
                        bodyContent += `<div class="message-item narration"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name gm-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${log.message}</div></div></div>`;
                }
                return;
            }

            
            if (log.type === 'NARRATION') {
                const profileHtml = profileImages[log.speaker]
                    ? `<img src="${profileImages[log.speaker]}" alt="${log.speaker}">`
                    : `<svg viewBox="0 0 24 24" fill="currentColor" style="width:40px;height:40px;color:#fbbf24;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                bodyContent += `<div class="message-item narration"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name gm-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${log.message}</div></div></div>`;
            } else {
                
                const profileHtml = profileImages[log.speaker]
                    ? `<img src="${profileImages[log.speaker]}" alt="${log.speaker}">`
                    : `<svg viewBox="0 0 24 24" fill="currentColor" style="width:40px;height:40px;color:#9ca3af;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                const messageLines = log.message.split('|||');
                const messageHtml = messageLines.map(line => `<div>${line}</div>`).join('');

                bodyContent += `<div class="message-item dialogue"${itemBgStyle}><div class="profile-img">${profileHtml}</div><div class="message-content"><div class="message-header"><span class="speaker-name" style="${speakerColorMap[log.speaker] || ''}">${log.speaker}</span>${tabLabel}</div><div class="message-text">${messageHtml}</div></div></div>`;
            }
        });
        flushChatBuffer();

        const partTitle = totalParts > 1 ? `${title} (Part ${partNum})` : title;
        const headerTitle = totalParts > 1 ? `${title} #${partNum}` : title;
        const footerIndicator = totalParts > 1 ? `<div class="page-footer">Page ${partNum} of ${totalParts}</div>` : '';

        const customFontImport = this.buildFontImport(customOptions);
        const defaultFontImport = customFontImport || `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');`;
        const fontMain = this.buildFontFamily(customOptions, `'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`);

        
        const fontSize = customOptions.fontSize || '15';
        const lineHeight = customOptions.lineHeight || '1.6';
        const pageWidth = customOptions.pageWidth || '900';

        
        const systemBgColor = customOptions.systemBgColor || '#f0f9ff';
        const systemBorderColor = customOptions.systemBorderColor || '#0ea5e9';
        const systemTextColor = customOptions.systemTextColor || '#075985';

        
        const themeBgColor = customOptions.themeBgColor || '#1e1e1e';
        const themeContainerColor = customOptions.themeContainerColor || '#2a2a2a';
        const themeTextColor = customOptions.themeTextColor || '#e5e7eb';
        const themeAccentColor = customOptions.themeAccentColor || '#60a5fa';

        const summaryHtml = summary ? `<p class="summary">${summary}</p>` : '';
        const participantsHtml = participants ? `<p class="participants">${participants}</p>` : '';

        return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${partTitle}</title>
    <style>
        ${defaultFontImport}

        :root {
            --bg-color: ${themeBgColor};
            --container-color: ${themeContainerColor};
            --text-color: ${themeTextColor};
            --accent-color: ${themeAccentColor};
            --border-color: rgba(255, 255, 255, 0.1);
            --system-bg-color: ${systemBgColor};
            --system-border-color: ${systemBorderColor};
            --system-text-color: ${systemTextColor};
            --font-main: ${fontMain};
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: ${fontSize}px;
            line-height: ${lineHeight};
        }

        .log-container {
            max-width: ${pageWidth}px;
            margin: 0 auto;
            background-color: var(--container-color);
            min-height: 100vh;
        }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent-color);
        }

        .header .participants {
            font-size: 0.9em;
            color: #9ca3af;
        }

        .header .summary {
            font-size: 0.85em;
            color: #9ca3af;
            margin-top: 8px;
            line-height: 1.5;
        }

        .messages-container {
            padding: 0;
        }

        .message-item {
            display: flex;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s;
        }

        .message-item:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .profile-img {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            margin-right: 12px;
        }

        .profile-img img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .system-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(96, 165, 250, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .speaker-name {
            font-weight: 700;
            font-size: 0.95em;
        }

        .speaker-name.system-name {
            color: var(--system-text-color);
        }

        .speaker-name.gm-name {
            color: #fbbf24;
        }

        .tab-label {
            font-size: 0.8em;
            color: #9ca3af;
        }

        .message-text {
            color: var(--text-color);
            word-wrap: break-word;
        }

        .message-text > div {
            margin: 2px 0;
        }

        .message-text.system-text {
            color: var(--system-text-color);
            background-color: var(--system-bg-color);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--system-border-color);
            font-size: 0.9em;
        }

        .message-text.narration-text {
            font-style: italic;
            color: #d1d5db;
        }

        /* 잡담 접기 */
        .chat-fold-container {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0, 0, 0, 0.2);
        }

        .chat-fold-container details {
            cursor: pointer;
        }

        .chat-fold-summary {
            font-size: 0.9em;
            color: #9ca3af;
            font-weight: 600;
            padding: 4px 0;
            cursor: pointer;
            user-select: none;
        }

        .chat-fold-summary:hover {
            color: #d1d5db;
        }

        .chat-fold-content {
            margin-top: 8px;
        }

        .chat-fold-content .message-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-fold-content .message-item:last-child {
            border-bottom: none;
        }

        .message-item.chat .message-text {
            color: #d1d5db;
            opacity: 0.9;
        }

        .page-footer {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
            font-size: 0.85em;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="log-container">
        <header class="header">
            <h1>${headerTitle}</h1>
            ${participantsHtml}
            ${summaryHtml}
        </header>
        <div class="messages-container">
            ${bodyContent}
        </div>
        ${footerIndicator}
    </div>
</body>
</html>`;
    }
}



class UIController {
    constructor() {
        this.profileImages = {};
        this.characterColors = {};
        this.tabStyleSettings = {};
        this.tabColorSettings = {};
        this.subNarrators = [];
        this.convertedHtmlChunks = [];
        this.fileNameBase = 'session_log';
        this.customTitle = '';
        this.customSubtitle = '';
    }

    
    collectSettings(elements) {
        const colorPresetSelect = document.getElementById('color-preset');
        return {
            style: document.querySelector('input[name="style"]:checked')?.value || 'novel',
            narratorSelect: elements.narratorSelect.value,
            oocTab: elements.oocTabSelect.value,
            customFontUrl: elements.customFontUrl.value,
            customFontFamily: elements.customFontFamily.value,
            mergeConsecutive: elements.mergeConsecutiveCheckbox.checked,
            fontSize: elements.fontSizeSelect.value,
            lineHeight: elements.lineHeightSelect.value,
            pageWidth: elements.pageWidthSelect.value,
            chatMode: elements.chatModeSelect.value,
            showChatCount: elements.showChatCountCheckbox.checked,
            systemMode: elements.systemModeSelect.value,
            colorPreset: colorPresetSelect?.value || 'black-red',
            themeBgColor: elements.themeBgColorInput.value,
            themeContainerColor: elements.themeContainerColorInput.value,
            themeTextColor: elements.themeTextColorInput.value,
            themeAccentColor: elements.themeAccentColorInput.value,
            systemBgColor: elements.systemBgColorInput.value,
            systemBorderColor: elements.systemBorderColorInput.value,
            systemTextColor: elements.systemTextColorInput.value,
            narrationBgColor: elements.narrationBgColorInput.value,
            narrationTextColor: elements.narrationTextColorInput.value,
            splitMethod: document.querySelector('input[name="split-method"]:checked')?.value || 'none',
            logLimitCount: elements.logLimitCountInput.value,
            logLimitSize: elements.logLimitSizeInput.value,
            logLimitFiles: elements.logLimitFilesInput.value,
            subNarrators: this.subNarrators,
            characterColors: this.characterColors,
            tabStyleSettings: this.tabStyleSettings,
            tabColorSettings: this.tabColorSettings,
            enableTabColors: document.getElementById('enable-tab-colors')?.checked || false,
            novelTypography: elements.novelTypographyToggle.checked
        };
    }

    
    saveSettings(elements) {
        const settings = this.collectSettings(elements);
        localStorage.setItem('ccfolia-converter-settings', JSON.stringify(settings));
    }

    
    loadSettings(elements, settingsObj = null) {
        try {
            let settings;
            if (settingsObj) {
                settings = settingsObj;
            } else {
                const saved = localStorage.getItem('ccfolia-converter-settings');
                if (!saved) return;
                try {
                    settings = JSON.parse(saved);
                } catch (parseError) {
                    console.error('설정 파일 파싱 실패:', parseError);
                    console.warn('저장된 설정을 불러올 수 없습니다. 기본값을 사용합니다.');
                    return;
                }
            }

            if (!settings || typeof settings !== 'object') {
                console.warn('유효하지 않은 설정 데이터입니다. 기본값을 사용합니다.');
                return;
            }

            
            try {
                
                if (settings.style) {
                    const styleRadio = document.querySelector(`input[name="style"][value="${settings.style}"]`);
                    if (styleRadio) styleRadio.checked = true;
                }
            } catch (e) { console.warn('스타일 설정 복원 실패:', e); }

            try {
                
                if (settings.customFontUrl && elements.customFontUrl)
                    elements.customFontUrl.value = settings.customFontUrl;
                if (settings.customFontFamily && elements.customFontFamily)
                    elements.customFontFamily.value = settings.customFontFamily;
                if (settings.mergeConsecutive !== undefined && elements.mergeConsecutiveCheckbox)
                    elements.mergeConsecutiveCheckbox.checked = settings.mergeConsecutive;
                if (settings.fontSize && elements.fontSizeSelect)
                    elements.fontSizeSelect.value = settings.fontSize;
                if (settings.lineHeight && elements.lineHeightSelect)
                    elements.lineHeightSelect.value = settings.lineHeight;
                if (settings.pageWidth && elements.pageWidthSelect)
                    elements.pageWidthSelect.value = settings.pageWidth;
            } catch (e) { console.warn('폰트/레이아웃 설정 복원 실패:', e); }

            try {
                
                if (settings.chatMode && elements.chatModeSelect)
                    elements.chatModeSelect.value = settings.chatMode;
                if (settings.showChatCount !== undefined && elements.showChatCountCheckbox)
                    elements.showChatCountCheckbox.checked = settings.showChatCount;
                if (settings.systemMode && elements.systemModeSelect)
                    elements.systemModeSelect.value = settings.systemMode;
                if (settings.oocTab !== undefined && elements.oocTabSelect)
                    elements.oocTabSelect.value = settings.oocTab;
            } catch (e) { console.warn('콘텐츠 표시 설정 복원 실패:', e); }

            try {
                
                const colorPresetSelect = document.getElementById('color-preset');
                if (settings.colorPreset && colorPresetSelect) {
                    colorPresetSelect.value = settings.colorPreset;
                    
                    if (settings.colorPreset !== 'custom') {
                        
                        colorPresetSelect.dispatchEvent(new Event('change'));
                    }
                }

                
                if (settings.colorPreset === 'custom') {
                    if (settings.themeBgColor && elements.themeBgColorInput)
                        elements.themeBgColorInput.value = settings.themeBgColor;
                    if (settings.themeContainerColor && elements.themeContainerColorInput)
                        elements.themeContainerColorInput.value = settings.themeContainerColor;
                    if (settings.themeTextColor && elements.themeTextColorInput)
                        elements.themeTextColorInput.value = settings.themeTextColor;
                    if (settings.themeAccentColor && elements.themeAccentColorInput)
                        elements.themeAccentColorInput.value = settings.themeAccentColor;
                    if (settings.systemBgColor && elements.systemBgColorInput)
                        elements.systemBgColorInput.value = settings.systemBgColor;
                    if (settings.systemBorderColor && elements.systemBorderColorInput)
                        elements.systemBorderColorInput.value = settings.systemBorderColor;
                    if (settings.systemTextColor && elements.systemTextColorInput)
                        elements.systemTextColorInput.value = settings.systemTextColor;
                    if (settings.narrationBgColor && elements.narrationBgColorInput)
                        elements.narrationBgColorInput.value = settings.narrationBgColor;
                    if (settings.narrationTextColor && elements.narrationTextColorInput)
                        elements.narrationTextColorInput.value = settings.narrationTextColor;
                }
            } catch (e) { console.warn('색상 설정 복원 실패:', e); }

            try {
                
                if (settings.splitMethod) {
                    const splitRadio = document.querySelector(`input[name="split-method"][value="${settings.splitMethod}"]`);
                    if (splitRadio) splitRadio.checked = true;
                }
                if (settings.logLimitCount && elements.logLimitCountInput)
                    elements.logLimitCountInput.value = settings.logLimitCount;
                if (settings.logLimitSize && elements.logLimitSizeInput)
                    elements.logLimitSizeInput.value = settings.logLimitSize;
                if (settings.logLimitFiles && elements.logLimitFilesInput)
                    elements.logLimitFilesInput.value = settings.logLimitFiles;

                
                if (elements.logLimitCountInput && elements.logLimitSizeInput && elements.logLimitFilesInput) {
                    elements.logLimitCountInput.disabled = settings.splitMethod !== 'count';
                    elements.logLimitSizeInput.disabled = settings.splitMethod !== 'size';
                    elements.logLimitFilesInput.disabled = settings.splitMethod !== 'files';
                }
            } catch (e) { console.warn('분할 옵션 설정 복원 실패:', e); }

            try {
                
                if (settings.subNarrators && Array.isArray(settings.subNarrators)) {
                    this.subNarrators = settings.subNarrators;
                }
            } catch (e) { console.warn('서브 나레이터 설정 복원 실패:', e); }

            try {
                
                if (settings.characterColors && typeof settings.characterColors === 'object') {
                    this.characterColors = settings.characterColors;
                }
            } catch (e) { console.warn('캐릭터 색상 설정 복원 실패:', e); }

            try {
                
                if (settings.tabStyleSettings && typeof settings.tabStyleSettings === 'object') {
                    this.tabStyleSettings = settings.tabStyleSettings;
                }
            } catch (e) { console.warn('탭 스타일 설정 복원 실패:', e); }

            try {
                
                if (settings.tabColorSettings && typeof settings.tabColorSettings === 'object') {
                    this.tabColorSettings = settings.tabColorSettings;
                }
                const enableTabColorsCheckbox = document.getElementById('enable-tab-colors');
                if (settings.enableTabColors !== undefined && enableTabColorsCheckbox) {
                    enableTabColorsCheckbox.checked = settings.enableTabColors;
                    
                    const tabColorPicker = document.getElementById('tab-color-picker');
                    if (tabColorPicker) {
                        if (settings.enableTabColors) {
                            tabColorPicker.classList.remove('hidden');
                        } else {
                            tabColorPicker.classList.add('hidden');
                        }
                    }
                }
            } catch (e) { console.warn('탭 색상 설정 복원 실패:', e); }

            try {
                
                if (settings.novelTypography !== undefined && elements.novelTypographyToggle) {
                    elements.novelTypographyToggle.checked = settings.novelTypography;
                }
            } catch (e) { console.warn('타이포그래피 설정 복원 실패:', e); }

            console.info('설정이 성공적으로 복원되었습니다.');
        } catch (error) {
            console.error('설정 복원 중 예상치 못한 오류 발생:', error);
            console.warn('일부 설정이 기본값으로 초기화될 수 있습니다.');
        }
    }

    
    exportSettings(elements) {
        const settings = this.collectSettings(elements);
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const filename = `ccfolia-preset-${timestamp}.json`;

        const jsonString = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`설정이 "${filename}" 파일로 내보내졌습니다.`);
    }

    
    async importSettings(file, elements) {
        try {
            const text = await file.text();

            let settings;
            try {
                settings = JSON.parse(text);
            } catch (parseError) {
                console.error('JSON 파싱 실패:', parseError);
                alert('설정 파일 형식이 올바르지 않습니다. JSON 형식을 확인해주세요.');
                return;
            }

            if (!settings || typeof settings !== 'object') {
                console.error('유효하지 않은 설정 데이터:', settings);
                alert('설정 파일에 유효한 데이터가 없습니다.');
                return;
            }

            
            this.loadSettings(elements, settings);

            try {
                
                const colorPresetSelect = document.getElementById('color-preset');
                if (colorPresetSelect && settings.colorPreset) {
                    colorPresetSelect.dispatchEvent(new Event('change'));
                }
            } catch (e) {
                console.warn('색상 프리셋 이벤트 트리거 실패:', e);
            }

            try {
                
                if (elements.logLimitCountInput && elements.logLimitSizeInput && elements.logLimitFilesInput) {
                    const splitMethod = settings.splitMethod || 'none';
                    elements.logLimitCountInput.disabled = splitMethod !== 'count';
                    elements.logLimitSizeInput.disabled = splitMethod !== 'size';
                    elements.logLimitFilesInput.disabled = splitMethod !== 'files';
                }
            } catch (e) {
                console.warn('분할 옵션 업데이트 실패:', e);
            }

            try {
                
                this.saveSettings(elements);
            } catch (e) {
                console.warn('설정 저장 실패:', e);
            }

            console.info('설정 가져오기 완료');
            alert('설정을 성공적으로 불러왔습니다!');
        } catch (error) {
            console.error('설정 가져오기 중 예상치 못한 오류:', error);
            alert('설정 파일을 불러오는 중 오류가 발생했습니다.\n디버그 콘솔을 확인해주세요.');
        }
    }

    initEventListeners(elements, handlers) {
        
        this.loadSettings(elements);

        
        const autoSaveSettings = () => this.saveSettings(elements);

        
        elements.styleRadios.forEach(radio => radio.addEventListener('change', autoSaveSettings));
        elements.customFontUrl.addEventListener('input', autoSaveSettings);
        elements.customFontFamily.addEventListener('input', autoSaveSettings);
        elements.mergeConsecutiveCheckbox.addEventListener('change', autoSaveSettings);
        elements.fontSizeSelect.addEventListener('change', autoSaveSettings);
        elements.lineHeightSelect.addEventListener('change', autoSaveSettings);
        elements.pageWidthSelect.addEventListener('change', autoSaveSettings);
        elements.chatModeSelect.addEventListener('change', autoSaveSettings);
        elements.showChatCountCheckbox.addEventListener('change', autoSaveSettings);
        elements.systemModeSelect.addEventListener('change', autoSaveSettings);
        elements.themeBgColorInput.addEventListener('input', autoSaveSettings);
        elements.themeContainerColorInput.addEventListener('input', autoSaveSettings);
        elements.themeTextColorInput.addEventListener('input', autoSaveSettings);
        elements.themeAccentColorInput.addEventListener('input', autoSaveSettings);
        elements.systemBgColorInput.addEventListener('input', autoSaveSettings);
        elements.systemBorderColorInput.addEventListener('input', autoSaveSettings);
        elements.systemTextColorInput.addEventListener('input', autoSaveSettings);
        elements.narrationBgColorInput.addEventListener('input', autoSaveSettings);
        elements.narrationTextColorInput.addEventListener('input', autoSaveSettings);
        elements.splitMethodRadios.forEach(radio => radio.addEventListener('change', autoSaveSettings));
        elements.logLimitCountInput.addEventListener('input', autoSaveSettings);
        elements.logLimitSizeInput.addEventListener('input', autoSaveSettings);
        elements.logLimitFilesInput.addEventListener('input', autoSaveSettings);
        elements.oocTabSelect.addEventListener('change', autoSaveSettings);
        elements.novelTypographyToggle.addEventListener('change', autoSaveSettings);

        
        const enableTabColorsCheckbox = document.getElementById('enable-tab-colors');
        if (enableTabColorsCheckbox) {
            enableTabColorsCheckbox.addEventListener('change', autoSaveSettings);
        }

        
        elements.styleRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const selectedStyle = document.querySelector('input[name="style"]:checked').value;
                if (selectedStyle === 'timeline' || selectedStyle === 'original') {
                    elements.profileImageSection.classList.remove('hidden');
                } else {
                    elements.profileImageSection.classList.add('hidden');
                }

                
                if (selectedStyle === 'novel') {
                    elements.novelTypographyOption.classList.remove('hidden');
                } else {
                    elements.novelTypographyOption.classList.add('hidden');
                }
            });
        });

        
        elements.splitMethodRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                elements.logLimitCountInput.disabled = !elements.splitCountRadio.checked;
                elements.logLimitSizeInput.disabled = !elements.splitSizeRadio.checked;
                elements.logLimitFilesInput.disabled = !elements.splitFilesRadio.checked;
            });
        });

        
        elements.logFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            elements.profileSettingsSection.style.display = 'block';
            if (elements.outputOptionsSection) elements.outputOptionsSection.style.display = 'block';
            if (elements.splitOptionsSection) elements.splitOptionsSection.style.display = 'block';
            elements.profileUploaderDiv.innerHTML = '<p class="text-gray-500">로그 파일을 분석하여 화자를 인식하는 중...</p>';

            try {
                const rawHtml = await file.text();
                const parsedLogs = handlers.parseLog(rawHtml);
                const speakers = [...new Set(parsedLogs.map(log => log.speaker))];
                const tabs = handlers.extractTabs(rawHtml);

                
                if (this.subNarrators && this.subNarrators.length > 0) {
                    this.subNarrators = this.subNarrators.filter(config =>
                        speakers.includes(config.speaker)
                    );
                }

                this.setupNarratorSelect(speakers, elements.narratorSelect);
                this.setupOocTabSelect(tabs, elements.oocTabSelect);
                this.setupProfileUploader(speakers, elements.profileUploaderDiv);
                this.setupCharacterColorPicker(speakers, elements.characterColorPicker);
                this.setupTabStylePicker(tabs, elements.tabStylePicker);
                this.setupTabColorPicker(tabs, document.getElementById('tab-color-picker'));
                this.setupSubNarrators(speakers, elements.subNarratorPicker);

                
                this.extractTitleFromFilename(file.name, elements.customTitleInput, elements.customSubtitleInput);

                
                elements.characterColorSection.style.display = 'block';

                
                elements.subNarratorSection.classList.remove('hidden');

                
                if (tabs.length > 1) {
                    elements.tabStyleSection.classList.remove('hidden');
                    
                    const tabColorSection = document.getElementById('tab-color-section');
                    if (tabColorSection) {
                        tabColorSection.classList.remove('hidden');
                    }
                }

                
                const selectedStyle = document.querySelector('input[name="style"]:checked').value;
                if (selectedStyle === 'timeline' || selectedStyle === 'original') {
                    elements.profileImageSection.classList.remove('hidden');
                }
            } catch (error) {
                elements.profileUploaderDiv.innerHTML = '<p class="text-red-500">파일을 분석하는 데 실패했습니다.</p>';
                console.error("File parsing error:", error);
            }
        });

        
        elements.convertBtn.addEventListener('click', () => {
            const file = elements.logFileInput.files[0];
            const selectedStyle = document.querySelector('input[name="style"]:checked').value;

            if (!file) {
                alert('먼저 로그 파일을 선택해주세요.');
                return;
            }

            this.fileNameBase = file.name.replace('.html', '');
            elements.resultSection.classList.remove('hidden');
            elements.statusDiv.textContent = '로그 파일을 읽고 분석하는 중입니다...';
            elements.previewFrame.classList.add('opacity-0');
            elements.downloadContainer.innerHTML = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                const rawHtml = e.target.result;
                try {
                    const narratorName = elements.narratorSelect.value;
                    const oocTabName = elements.oocTabSelect.value;
                    let allParsedLogs = handlers.parseLog(rawHtml, narratorName, oocTabName);

                    
                    if (elements.mergeConsecutiveCheckbox.checked) {
                        allParsedLogs = this.mergeConsecutiveSpeakers(allParsedLogs);
                    }

                    const splitMethod = document.querySelector('input[name="split-method"]:checked').value;
                    let splitValue = 0;
                    if (splitMethod === 'count') {
                        splitValue = parseInt(elements.logLimitCountInput.value, 10) || 0;
                    } else if (splitMethod === 'size') {
                        splitValue = parseInt(elements.logLimitSizeInput.value, 10) || 0;
                    } else if (splitMethod === 'files') {
                        splitValue = parseInt(elements.logLimitFilesInput.value, 10) || 2;
                    }

                    elements.statusDiv.textContent = `총 ${allParsedLogs.length}개의 로그를 분석했습니다. 선택한 스타일로 변환합니다...`;

                    
                    const customOptions = {
                        title: elements.customTitleInput.value || null,
                        subtitle: elements.customSubtitleInput.value || null,
                        summary: elements.customSummaryInput?.value || null,
                        fontUrl: elements.customFontUrl.value || null,
                        fontFamily: elements.customFontFamily.value || null,
                        fontSize: elements.fontSizeSelect.value || '17',
                        lineHeight: elements.lineHeightSelect.value || '1.8',
                        pageWidth: elements.pageWidthSelect.value || '750',
                        chatMode: elements.chatModeSelect.value || 'collapse',
                        showChatCount: elements.showChatCountCheckbox?.checked || false,
                        hideSystem: elements.systemModeSelect.value === 'hide',
                        systemBgColor: elements.systemBgColorInput.value || null,
                        systemBorderColor: elements.systemBorderColorInput.value || null,
                        systemTextColor: elements.systemTextColorInput.value || null,
                        narrationBgColor: elements.narrationBgColorInput.value || null,
                        narrationTextColor: elements.narrationTextColorInput.value || null,
                        themeBgColor: elements.themeBgColorInput?.value || null,
                        themeContainerColor: elements.themeContainerColorInput?.value || null,
                        themeTextColor: elements.themeTextColorInput?.value || null,
                        themeAccentColor: elements.themeAccentColorInput?.value || null,
                        characterColors: this.characterColors,
                        tabStyles: this.tabStyleSettings,
                        tabColors: this.tabColorSettings,
                        enableTabColors: document.getElementById('enable-tab-colors')?.checked || false,
                        subNarrators: this.subNarrators,
                        novelTypography: elements.novelTypographyToggle.checked
                    };

                    this.convertedHtmlChunks = handlers.generateHTML(
                        selectedStyle,
                        allParsedLogs,
                        this.fileNameBase,
                        this.profileImages,
                        splitMethod,
                        splitValue,
                        customOptions
                    );

                    if (this.convertedHtmlChunks.length > 0) {
                        elements.previewFrame.srcdoc = this.convertedHtmlChunks[0];
                        elements.previewFrame.onload = () => {
                            elements.previewFrame.classList.remove('opacity-0');
                            if(this.convertedHtmlChunks.length > 1) {
                                elements.statusDiv.textContent = `변환 완료! 로그가 ${this.convertedHtmlChunks.length}개의 파일로 분할되었습니다.`;
                            } else {
                                elements.statusDiv.textContent = '변환이 완료되었습니다. 아래에서 미리보기를 확인하세요.';
                            }
                            this.setupDownloadButtons(elements.downloadContainer);
                        };
                    }

                } catch (error) {
                    
                    console.error('===== Error during conversion =====');
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Stack trace:', error.stack);
                    console.error('Full error object:', JSON.stringify(error, Object.getOwnPropertyNames(error), 2));
                    console.error('===================================');

                    elements.statusDiv.textContent = `오류가 발생했습니다: ${error.message || '알 수 없는 오류'}`;
                    alert(`로그 변환 중 오류가 발생했습니다.\n\n에러: ${error.message || '알 수 없는 오류'}\n\n개발자 콘솔에서 자세한 내용을 확인해주세요.`);
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        
        const exportPresetBtn = document.getElementById('export-preset-btn');
        if (exportPresetBtn) {
            exportPresetBtn.addEventListener('click', () => {
                this.exportSettings(elements);
            });
        }

        
        const importPresetInput = document.getElementById('import-preset-input');
        if (importPresetInput) {
            importPresetInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    await this.importSettings(file, elements);
                    
                    event.target.value = '';
                }
            });
        }

        
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        if (resetSettingsBtn) {
            resetSettingsBtn.addEventListener('click', () => {
                const confirmed = confirm('정말로 모든 설정을 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없으며, 저장된 모든 설정이 기본값으로 되돌아갑니다.');
                if (confirmed) {
                    try {
                        
                        localStorage.removeItem('ccfolia-converter-settings');
                        console.info('설정이 초기화되었습니다. 페이지를 새로고침합니다.');
                        
                        window.location.reload();
                    } catch (error) {
                        console.error('설정 초기화 중 오류 발생:', error);
                        alert('설정 초기화 중 오류가 발생했습니다. 디버그 콘솔을 확인해주세요.');
                    }
                }
            });
        }

        
        const initialStyle = document.querySelector('input[name="style"]:checked')?.value || 'novel';
        if (initialStyle === 'novel') {
            elements.novelTypographyOption.classList.remove('hidden');
        } else {
            elements.novelTypographyOption.classList.add('hidden');
        }

        if (initialStyle === 'timeline' || initialStyle === 'original') {
            elements.profileImageSection.classList.remove('hidden');
        } else {
            elements.profileImageSection.classList.add('hidden');
        }
    }

    setupNarratorSelect(speakers, selectElement) {
        
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }

        
        speakers.forEach(speaker => {
            if (speaker !== 'system') {
                const option = document.createElement('option');
                option.value = speaker;
                option.textContent = speaker;
                if (speaker === 'GM') {
                    selectElement.selectedIndex = selectElement.options.length - 1;
                }
                selectElement.appendChild(option);
            }
        });
    }

    setupOocTabSelect(tabs, selectElement) {
        
        while (selectElement.options.length > 1) {
            selectElement.remove(1);
        }

        
        tabs.forEach(tab => {
            const option = document.createElement('option');
            option.value = tab;
            option.textContent = tab;
            selectElement.appendChild(option);
        });

        
        if (tabs.includes('잡담')) {
            selectElement.value = '잡담';
        } else if (tabs.includes('other')) {
            selectElement.value = 'other';
        } else {
            selectElement.selectedIndex = 0; // "사용 안 함"
        }
    }

    setupProfileUploader(speakers, containerElement) {
        containerElement.innerHTML = '';
        this.profileImages = {};

        speakers.forEach(speaker => {
            const uploaderHTML = `
                <div class="profile-card">
                    <div class="flex items-center gap-3 mb-3">
                        <img id="preview-${speaker}" src="https://placehold.co/64x64/1a1a1a/666666?text=${speaker[0]}" alt="${speaker}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-600">
                        <p class="font-semibold text-gray-200 flex-1">${speaker}</p>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="radio" name="img-type-${speaker}" value="file" id="file-${speaker}" checked>
                            <label for="file-${speaker}" class="text-sm cursor-pointer">파일 업로드</label>
                        </div>
                        <input type="file" accept="image/*" data-speaker="${speaker}" class="profile-image-input w-full text-sm">

                        <div class="flex items-center gap-2">
                            <input type="radio" name="img-type-${speaker}" value="url" id="url-${speaker}">
                            <label for="url-${speaker}" class="text-sm cursor-pointer">이미지 URL</label>
                        </div>
                        <input type="text" placeholder="https://example.com/image.jpg" data-speaker="${speaker}" class="profile-url-input w-full" disabled>
                    </div>
                </div>`;
            containerElement.insertAdjacentHTML('beforeend', uploaderHTML);
        });

        
        document.querySelectorAll('[id^="file-"], [id^="url-"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const speaker = event.target.name.replace('img-type-', '');
                const isFile = event.target.value === 'file';
                const fileInput = document.querySelector(`.profile-image-input[data-speaker="${speaker}"]`);
                const urlInput = document.querySelector(`.profile-url-input[data-speaker="${speaker}"]`);

                fileInput.disabled = !isFile;
                urlInput.disabled = isFile;
            });
        });

        
        document.querySelectorAll('.profile-image-input').forEach(input => {
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                const speaker = event.target.dataset.speaker;
                if (file && speaker) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.profileImages[speaker] = e.target.result;
                        document.getElementById(`preview-${speaker}`).src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        
        document.querySelectorAll('.profile-url-input').forEach(input => {
            input.addEventListener('input', async (event) => {
                const url = event.target.value.trim();
                const speaker = event.target.dataset.speaker;

                if (url && speaker) {
                    try {
                        
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`이미지 로드 실패: ${response.status}`);
                        }

                        const blob = await response.blob();
                        const reader = new FileReader();

                        reader.onload = (e) => {
                            const dataUrl = e.target.result;
                            this.profileImages[speaker] = dataUrl;
                            document.getElementById(`preview-${speaker}`).src = dataUrl;
                            console.info(`${speaker}의 프로필 이미지가 Data URL로 변환되었습니다.`);
                        };

                        reader.onerror = () => {
                            console.error(`${speaker}의 프로필 이미지 변환 중 오류 발생`);
                            
                            this.profileImages[speaker] = url;
                            document.getElementById(`preview-${speaker}`).src = url;
                        };

                        reader.readAsDataURL(blob);
                    } catch (error) {
                        console.error(`이미지 URL 로드 실패 (${url}):`, error);
                        console.warn('CORS 정책 또는 네트워크 오류로 인해 이미지를 Data URL로 변환할 수 없습니다.');
                        alert(`이미지를 불러올 수 없습니다: ${error.message}\n\nCORS 정책으로 차단되었거나 URL이 올바르지 않을 수 있습니다.\n파일 업로드 방식을 사용하시면 문제없이 임베딩됩니다.`);
                        
                        delete this.profileImages[speaker];
                        document.getElementById(`preview-${speaker}`).src = 'https://placehold.co/64x64/EFEFEF/AAAAAA?text=PIC';
                    }
                } else if (speaker) {
                    delete this.profileImages[speaker];
                    document.getElementById(`preview-${speaker}`).src = 'https://placehold.co/64x64/EFEFEF/AAAAAA?text=PIC';
                }
            });
        });
    }

    setupCharacterColorPicker(speakers, containerElement) {
        containerElement.innerHTML = '';
        this.characterColors = {};

        
        const defaultColors = ['#d9480f', '#1c7ed6', '#2b6777', '#862e9c', '#5c940d'];

        speakers.forEach((speaker, index) => {
            if (speaker === 'system') return; // 시스템 메시지는 제외

            const defaultColor = defaultColors[index % defaultColors.length];
            const pickerHTML = `
                <div class="color-card">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold text-gray-200">${speaker}</p>
                        <div class="flex items-center gap-2">
                            <input type="color"
                                   value="${defaultColor}"
                                   data-speaker="${speaker}"
                                   class="character-color-input w-12 h-10 rounded cursor-pointer"
                                   title="색상 선택">
                            <code class="character-color-preview text-xs" style="color: ${defaultColor}">${defaultColor}</code>
                        </div>
                    </div>
                </div>`;
            containerElement.insertAdjacentHTML('beforeend', pickerHTML);
            this.characterColors[speaker] = defaultColor;
        });

        
        document.querySelectorAll('.character-color-input').forEach(input => {
            input.addEventListener('input', (event) => {
                const speaker = event.target.dataset.speaker;
                const color = event.target.value;
                this.characterColors[speaker] = color;

                
                const preview = event.target.nextElementSibling;
                if (preview) {
                    preview.style.color = color;
                    preview.textContent = color;
                }
            });
        });
    }

    setupTabStylePicker(tabs, containerElement) {
        containerElement.innerHTML = '';
        this.tabStyleSettings = {};

        tabs.forEach(tab => {
            
            const defaultStyle = 'none';

            const pickerHTML = `
                <div class="color-card" style="padding: 0.6rem 0.8rem;">
                    <div class="flex items-center justify-between gap-3">
                        <span class="text-sm font-medium" style="color: #fca5a5;">[${tab}]</span>
                        <select data-tab="${tab}" class="tab-style-select text-sm px-2 py-1.5" style="flex: 1; max-width: 180px;">
                            <option value="none" selected>라벨 없음</option>
                            <option value="label">이름 옆 라벨</option>
                            <option value="system">시스템 박스</option>
                            <option value="hide">숨기기</option>
                        </select>
                    </div>
                </div>`;
            containerElement.insertAdjacentHTML('beforeend', pickerHTML);
            this.tabStyleSettings[tab] = defaultStyle;
        });

        
        document.querySelectorAll('.tab-style-select').forEach(select => {
            select.addEventListener('change', (event) => {
                const tab = event.target.dataset.tab;
                const style = event.target.value;
                this.tabStyleSettings[tab] = style;
            });
        });
    }

    setupTabColorPicker(tabs, containerElement) {
        if (!containerElement) return;

        containerElement.innerHTML = '';

        tabs.forEach(tab => {
            
            const existingColor = this.tabColorSettings[tab] || { textColor: '#e5e7eb', bgColor: 'transparent' };

            const pickerHTML = `
                <div class="color-card">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-semibold" style="color: #fca5a5;">[${tab}]</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs mb-1.5 text-muted">텍스트 색상</label>
                            <div class="flex items-center gap-2">
                                <input type="color"
                                       value="${existingColor.textColor}"
                                       data-tab="${tab}"
                                       data-type="text"
                                       class="tab-color-input"
                                       style="width: 3rem; height: 2.2rem;">
                                <code class="tab-color-preview-text text-xs" style="color: ${existingColor.textColor}">${existingColor.textColor}</code>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs mb-1.5 text-muted">배경 색상</label>
                            <div class="flex items-center gap-2">
                                <input type="color"
                                       value="${existingColor.bgColor === 'transparent' ? '#000000' : existingColor.bgColor}"
                                       data-tab="${tab}"
                                       data-type="bg"
                                       class="tab-color-input"
                                       style="width: 3rem; height: 2.2rem;">
                                <code class="tab-color-preview-bg text-xs text-muted">${existingColor.bgColor}</code>
                            </div>
                        </div>
                    </div>
                </div>`;
            containerElement.insertAdjacentHTML('beforeend', pickerHTML);

            if (!this.tabColorSettings[tab]) {
                this.tabColorSettings[tab] = existingColor;
            }
        });

        
        document.querySelectorAll('.tab-color-input').forEach(input => {
            input.addEventListener('input', (event) => {
                const tab = event.target.dataset.tab;
                const type = event.target.dataset.type; // 'text' or 'bg'
                const color = event.target.value;

                if (!this.tabColorSettings[tab]) {
                    this.tabColorSettings[tab] = { textColor: '#e5e7eb', bgColor: 'transparent' };
                }

                if (type === 'text') {
                    this.tabColorSettings[tab].textColor = color;
                    
                    const preview = event.target.parentElement.querySelector('.tab-color-preview-text');
                    if (preview) {
                        preview.style.color = color;
                        preview.textContent = color;
                    }
                } else if (type === 'bg') {
                    this.tabColorSettings[tab].bgColor = color;
                    
                    const preview = event.target.parentElement.querySelector('.tab-color-preview-bg');
                    if (preview) {
                        preview.textContent = color;
                    }
                }
            });
        });
    }

    setupSubNarrators(speakers, containerElement) {
        
        if (!this.subNarrators) {
            this.subNarrators = [];
        }

        
        this.availableSpeakers = speakers.filter(s => s !== 'system');

        
        const speakerSelect = document.getElementById('sub-narrator-speaker-select');
        const addBtn = document.getElementById('sub-narrator-add-btn');
        const listContainer = document.getElementById('sub-narrator-list');
        const emptyMessage = document.getElementById('sub-narrator-empty-message');

        
        this.updateSubNarratorDropdown();

        
        this.subNarrators.forEach(config => {
            this.addSubNarratorCard(config.speaker, config.style, config.color);
        });

        
        this.updateEmptyMessage();

        
        addBtn.addEventListener('click', () => {
            const selectedSpeaker = speakerSelect.value;
            if (!selectedSpeaker) {
                return;
            }

            
            this.addSubNarratorCard(selectedSpeaker, 'italic-narration', '#9ca3af');

            
            this.subNarrators.push({
                speaker: selectedSpeaker,
                style: 'italic-narration',
                color: '#9ca3af'
            });

            
            this.updateSubNarratorDropdown();

            
            this.updateEmptyMessage();
        });
    }

    updateSubNarratorDropdown() {
        const speakerSelect = document.getElementById('sub-narrator-speaker-select');
        if (!speakerSelect) return;

        
        const addedSpeakers = this.subNarrators.map(n => n.speaker);
        const availableOptions = this.availableSpeakers.filter(s => !addedSpeakers.includes(s));

        
        speakerSelect.innerHTML = '<option value="">서브 나레이터로 지정할 화자 선택</option>';
        availableOptions.forEach(speaker => {
            const option = document.createElement('option');
            option.value = speaker;
            option.textContent = speaker;
            speakerSelect.appendChild(option);
        });

        
        const addBtn = document.getElementById('sub-narrator-add-btn');
        if (addBtn) {
            addBtn.disabled = availableOptions.length === 0;
        }
    }

    addSubNarratorCard(speaker, style, color) {
        const listContainer = document.getElementById('sub-narrator-list');
        if (!listContainer) return;

        const cardHTML = `
            <div class="sub-narrator-card bg-gray-800 border border-gray-700 rounded transition-all duration-300" data-speaker="${speaker}" style="opacity:0; transform: translateY(-10px);">
                <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700">
                    <div class="font-semibold text-sm text-gray-200">${speaker}</div>
                    <button class="sub-narrator-remove-btn text-gray-500 hover:text-red-400 text-2xl leading-none transition-colors" data-speaker="${speaker}" title="삭제">&times;</button>
                </div>
                <div class="p-3 flex items-center gap-3">
                    <select data-speaker="${speaker}" class="sub-narrator-style-select flex-1 bg-gray-700 border-gray-600 text-gray-200 text-xs px-2 py-1 rounded">
                        <option value="italic-narration" ${style === 'italic-narration' ? 'selected' : ''}>이탤릭체 나레이션</option>
                        <option value="normal-narration" ${style === 'normal-narration' ? 'selected' : ''}>일반 나레이션</option>
                        <option value="italic-dialogue" ${style === 'italic-dialogue' ? 'selected' : ''}>이탤릭체 대화</option>
                        <option value="colored-narration" ${style === 'colored-narration' ? 'selected' : ''}>색상 나레이션</option>
                    </select>
                    <div class="sub-narrator-color-picker ${style === 'colored-narration' ? 'flex' : 'hidden'} items-center gap-2">
                        <input type="color"
                               value="${color}"
                               data-speaker="${speaker}"
                               class="sub-narrator-color-input w-12 h-8 rounded cursor-pointer border border-gray-600"
                               title="나레이션 색상 선택">
                    </div>
                </div>
            </div>`;

        listContainer.insertAdjacentHTML('beforeend', cardHTML);

        
        const cardElement = listContainer.querySelector(`.sub-narrator-card[data-speaker="${speaker}"]`);
        setTimeout(() => {
            cardElement.style.opacity = '1';
            cardElement.style.transform = 'translateY(0)';
        }, 10);

        
        const card = listContainer.querySelector(`.sub-narrator-card[data-speaker="${speaker}"]`);

        
        const styleSelect = card.querySelector('.sub-narrator-style-select');
        styleSelect.addEventListener('change', (event) => {
            const newStyle = event.target.value;
            const colorPicker = card.querySelector('.sub-narrator-color-picker');
            const colorInput = card.querySelector('.sub-narrator-color-input');

            
            if (newStyle === 'colored-narration') {
                colorPicker.classList.remove('hidden');
            } else {
                colorPicker.classList.add('hidden');
            }

            
            this.updateSubNarratorConfig(speaker, newStyle, colorInput.value);
        });

        
        const colorInput = card.querySelector('.sub-narrator-color-input');
        colorInput.addEventListener('input', (event) => {
            const newColor = event.target.value;
            const style = styleSelect.value;
            this.updateSubNarratorConfig(speaker, style, newColor);
        });

        
        const removeBtn = card.querySelector('.sub-narrator-remove-btn');
        removeBtn.addEventListener('click', () => {
            
            card.remove();

            
            this.subNarrators = this.subNarrators.filter(n => n.speaker !== speaker);

            
            this.updateSubNarratorDropdown();

            
            this.updateEmptyMessage();
        });
    }

    updateEmptyMessage() {
        const emptyMessage = document.getElementById('sub-narrator-empty-message');
        const listContainer = document.getElementById('sub-narrator-list');

        if (!emptyMessage || !listContainer) return;

        const hasCards = listContainer.querySelectorAll('.sub-narrator-card').length > 0;
        emptyMessage.style.display = hasCards ? 'none' : 'block';
    }

    updateSubNarratorConfig(speaker, style, color) {
        
        const existing = this.subNarrators.find(n => n.speaker === speaker);
        if (existing) {
            existing.style = style;
            existing.color = color;
        } else {
            this.subNarrators.push({ speaker, style, color });
        }
    }

    setupDownloadButtons(containerElement) {
        containerElement.innerHTML = '';

        
        if (this.convertedHtmlChunks.length > 1) {
            const zipButton = document.createElement('button');
            zipButton.className = 'btn-download';
            zipButton.innerHTML = `📦 전체 다운로드 (ZIP)`;
            zipButton.onclick = async () => {
                try {
                    zipButton.disabled = true;
                    zipButton.innerHTML = '📦 압축 중...';

                    const zip = new JSZip();
                    this.convertedHtmlChunks.forEach((chunk, index) => {
                        const fileName = `${this.fileNameBase}_part${index + 1}.html`;
                        zip.file(fileName, chunk);
                    });

                    const content = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.fileNameBase}_all.zip`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    zipButton.disabled = false;
                    zipButton.innerHTML = `📦 전체 다운로드 (ZIP)`;
                } catch (error) {
                    console.error('ZIP 생성 오류:', error);
                    alert('ZIP 파일 생성 중 오류가 발생했습니다.');
                    zipButton.disabled = false;
                    zipButton.innerHTML = `📦 전체 다운로드 (ZIP)`;
                }
            };
            containerElement.appendChild(zipButton);
        }

        
        this.convertedHtmlChunks.forEach((chunk, index) => {
            const button = document.createElement('button');
            button.className = 'btn-download';
            button.innerHTML = this.convertedHtmlChunks.length > 1
                ? `📄 파일 ${index + 1} 다운로드`
                : '📥 HTML 다운로드';
            button.onclick = () => {
                const blob = new Blob([chunk], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const partSuffix = this.convertedHtmlChunks.length > 1 ? `_part${index + 1}` : '';
                a.download = `${this.fileNameBase}${partSuffix}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            containerElement.appendChild(button);
        });
    }

    extractTitleFromFilename(filename, titleInput, subtitleInput) {
        
        
        const nameWithoutExt = filename.replace('.html', '');

        const titleMatch = nameWithoutExt.match(/\]\s*(.*?)\s*\[/);
        const title = titleMatch ? titleMatch[1] : nameWithoutExt;

        const participantsMatch = nameWithoutExt.match(/^\[(.*?)\]/);
        const subtitle = participantsMatch ? participantsMatch[1] : '';

        titleInput.value = title;
        subtitleInput.value = subtitle;
    }

    mergeConsecutiveSpeakers(logs) {
        if (logs.length === 0) return logs;

        const merged = [];
        let current = { ...logs[0] };

        for (let i = 1; i < logs.length; i++) {
            const log = logs[i];

            
            if (log.speaker === current.speaker && log.type === current.type && log.type === 'DIALOGUE') {
                current.message += '|||' + log.message;
            } else {
                merged.push(current);
                current = { ...log };
            }
        }
        merged.push(current);

        return merged;
    }
}











const debugLogs = [];
let errorCount = 0;

const debugLogsContainer = document.getElementById('debug-logs');
const debugConsole = document.getElementById('debug-console');
const debugToggleBtn = document.getElementById('debug-toggle-btn');
const debugCopyBtn = document.getElementById('debug-copy-btn');
const debugClearBtn = document.getElementById('debug-clear-btn');
const debugErrorBadge = document.getElementById('debug-error-badge');


function addDebugLog(type, ...args) {
    const timestamp = new Date().toLocaleTimeString('ko-KR');
    const message = args.map(arg => {
        if (typeof arg === 'object') {
            try {
                return JSON.stringify(arg, null, 2);
            } catch (e) {
                return String(arg);
            }
        }
        return String(arg);
    }).join(' ');

    debugLogs.push({ type, timestamp, message });

    
    const typeColors = {
        log: 'text-gray-300',
        info: 'text-blue-400',
        warn: 'text-yellow-400',
        error: 'text-red-400'
    };

    const typeIcons = {
        log: '📝',
        info: 'ℹ️',
        warn: '⚠️',
        error: '❌'
    };

    const logElement = document.createElement('div');
    logElement.className = `${typeColors[type]} py-1 border-b border-gray-800`;
    logElement.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${typeIcons[type]} ${message}`;

    
    const placeholder = debugLogsContainer.querySelector('.text-gray-500');
    if (placeholder && placeholder.textContent.includes('콘솔 로그가 여기에 표시됩니다')) {
        placeholder.remove();
    }

    debugLogsContainer.appendChild(logElement);
    debugLogsContainer.scrollTop = debugLogsContainer.scrollHeight;

    
    if (type === 'error') {
        errorCount++;
        debugErrorBadge.textContent = errorCount;
        debugErrorBadge.classList.remove('hidden');
        
        if (debugConsole.classList.contains('hidden')) {
            debugConsole.classList.remove('hidden');
        }
    }
}


const originalConsole = {
    log: console.log,
    info: console.info,
    warn: console.warn,
    error: console.error
};


console.log = function(...args) {
    originalConsole.log.apply(console, args);
    addDebugLog('log', ...args);
};

console.info = function(...args) {
    originalConsole.info.apply(console, args);
    addDebugLog('info', ...args);
};

console.warn = function(...args) {
    originalConsole.warn.apply(console, args);
    addDebugLog('warn', ...args);
};

console.error = function(...args) {
    originalConsole.error.apply(console, args);
    addDebugLog('error', ...args);
};


debugToggleBtn.addEventListener('click', () => {
    debugConsole.classList.toggle('hidden');
});


debugCopyBtn.addEventListener('click', () => {
    const logText = debugLogs.map(log => `[${log.timestamp}] [${log.type.toUpperCase()}] ${log.message}`).join('\n');
    navigator.clipboard.writeText(logText).then(() => {
        const originalText = debugCopyBtn.textContent;
        debugCopyBtn.textContent = '✅ 복사됨!';
        setTimeout(() => {
            debugCopyBtn.textContent = originalText;
        }, 2000);
    }).catch(err => {
        alert('복사 실패: ' + err.message);
    });
});


debugClearBtn.addEventListener('click', () => {
    debugLogs.length = 0;
    debugLogsContainer.innerHTML = '<div class="text-gray-500">콘솔 로그가 여기에 표시됩니다...</div>';
    errorCount = 0;
    debugErrorBadge.classList.add('hidden');
});


window.addEventListener('error', (event) => {
    console.error('전역 에러:', event.error?.message || event.message, event.error?.stack || '');
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('처리되지 않은 Promise 거부:', event.reason);
});


const elements = {
    logFileInput: document.getElementById('logFile'),
    convertBtn: document.getElementById('convertBtn'),
    resultSection: document.getElementById('result'),
    statusDiv: document.getElementById('status'),
    previewFrame: document.getElementById('preview-frame'),
    downloadContainer: document.getElementById('download-container'),
    profileSettingsSection: document.getElementById('profile-settings'),
    profileUploaderDiv: document.getElementById('profile-uploader'),
    profileImageSection: document.getElementById('profile-image-section'),
    characterColorSection: document.getElementById('character-color-section'),
    characterColorPicker: document.getElementById('character-color-picker'),
    narratorSelect: document.getElementById('narrator-select'),
    oocTabSelect: document.getElementById('ooc-tab-select'),
    customTitleInput: document.getElementById('custom-title'),
    customSubtitleInput: document.getElementById('custom-subtitle'),
    customSummaryInput: document.getElementById('custom-summary'),
    customFontUrl: document.getElementById('custom-font-url'),
    customFontFamily: document.getElementById('custom-font-family'),
    mergeConsecutiveCheckbox: document.getElementById('merge-consecutive'),
    fontSizeSelect: document.getElementById('font-size'),
    lineHeightSelect: document.getElementById('line-height'),
    pageWidthSelect: document.getElementById('page-width'),
    chatModeSelect: document.getElementById('chat-mode'),
    showChatCountCheckbox: document.getElementById('show-chat-count'),
    systemModeSelect: document.getElementById('system-mode'),
    stampTextInput: document.getElementById('stamp-text'),
    systemBgColorInput: document.getElementById('system-bg-color'),
    systemBorderColorInput: document.getElementById('system-border-color'),
    systemTextColorInput: document.getElementById('system-text-color'),
    narrationBgColorInput: document.getElementById('narration-bg-color'),
    narrationTextColorInput: document.getElementById('narration-text-color'),
    themeBgColorInput: document.getElementById('theme-bg-color'),
    themeContainerColorInput: document.getElementById('theme-container-color'),
    themeTextColorInput: document.getElementById('theme-text-color'),
    themeAccentColorInput: document.getElementById('theme-accent-color'),
    styleRadios: document.querySelectorAll('input[name="style"]'),
    splitMethodRadios: document.querySelectorAll('input[name="split-method"]'),
    logLimitCountInput: document.getElementById('log-limit-count'),
    logLimitSizeInput: document.getElementById('log-limit-size'),
    logLimitFilesInput: document.getElementById('log-limit-files'),
    splitCountRadio: document.getElementById('split-count'),
    splitSizeRadio: document.getElementById('split-size'),
    splitFilesRadio: document.getElementById('split-files'),
    outputOptionsSection: document.getElementById('output-options'),
    splitOptionsSection: document.getElementById('split-options'),
    tabStyleSection: document.getElementById('tab-style-section'),
    tabStylePicker: document.getElementById('tab-style-picker'),
    subNarratorSection: document.getElementById('sub-narrator-section'),
    subNarratorPicker: document.getElementById('sub-narrator-picker'),
    novelTypographyOption: document.getElementById('novel-typography-option'),
    novelTypographyToggle: document.getElementById('novel-typography-toggle')
};


const generators = {
    novel: new NovelGenerator(),
    timeline: new TimelineGenerator(),
    report: new ReportGenerator(),
    original: new OriginalGenerator()
};


const uiController = new UIController();


const handlers = {
    parseLog: parseCocLog,
    extractTabs: extractTabs,
    generateHTML: (style, logs, fileName, profileImages, splitMethod, splitValue, customOptions = {}) => {
        const generator = generators[style];
        if (!generator) {
            throw new Error(`Unknown style: ${style}`);
        }
        return generator.generateChunks(logs, fileName, profileImages, splitMethod, splitValue, customOptions);
    }
};


uiController.initEventListeners(elements, handlers);


const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(button => {
    button.addEventListener('click', () => {
        const targetTabId = button.getAttribute('data-tab');

        
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        
        button.classList.add('active');
        document.getElementById(targetTabId).classList.add('active');
    });
});


const enableTabColorsCheckbox = document.getElementById('enable-tab-colors');
const tabColorPicker = document.getElementById('tab-color-picker');

if (enableTabColorsCheckbox) {
    enableTabColorsCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
            tabColorPicker.classList.remove('hidden');
        } else {
            tabColorPicker.classList.add('hidden');
        }
    });
}


const colorPresets = {
    'black-red': {
        systemBg: '#ffeb7a',
        systemBorder: '#7f1d1d',
        systemText: '#383b8a',
        narrationBg: '#30364f',
        narrationText: '#bdc4d1',
        themeBg: '#121212',
        themeContainer: '#212431',
        themeText: '#e5e7eb',
        themeAccent: '#7f1d1d'
    },
    'judgment': {
        systemBg: '#eef2ff',
        systemBorder: '#ca2121',
        systemText: '#ef4444',
        narrationBg: '#dfe5ec',
        narrationText: '#435070',
        themeBg: '#a1b0bf',
        themeContainer: '#dfe5ec',
        themeText: '#2a2c32',
        themeAccent: '#3c6cdd'
    },
    'monochrome': {
        systemBg: '#f5f5f5',
        systemBorder: '#666666',
        systemText: '#1a1a1a',
        narrationBg: '#333333',
        narrationText: '#cccccc',
        themeBg: '#1a1a1a',
        themeContainer: '#2a2a2a',
        themeText: '#e0e0e0',
        themeAccent: '#555555'
    },
    'pastel': {
        systemBg: '#fff5f7',
        systemBorder: '#fbb6ce',
        systemText: '#831843',
        narrationBg: '#e6f7ff',
        narrationText: '#0c4a6e',
        themeBg: '#fef6fb',
        themeContainer: '#fef0f5',
        themeText: '#4a5568',
        themeAccent: '#ed64a6'
    },
    'ocean': {
        systemBg: '#e0f2fe',
        systemBorder: '#38bdf8',
        systemText: '#0c4a6e',
        narrationBg: '#1e3a5f',
        narrationText: '#93c5fd',
        themeBg: '#0c1e33',
        themeContainer: '#1e3a5f',
        themeText: '#e0f2fe',
        themeAccent: '#0284c7'
    },
    'pink': {
        systemBg: '#fef3f6',
        systemBorder: '#fcc6dd',
        systemText: '#9d174d',
        narrationBg: '#fef3f6',
        narrationText: '#9d174d',
        themeBg: '#fffbfc',
        themeContainer: '#fff0f5',
        themeText: '#9d174d',
        themeAccent: '#fbb6ce'
    },
    'spring': {
        systemBg: '#f0fdf4',
        systemBorder: '#86efac',
        systemText: '#166534',
        narrationBg: '#fef3f6',
        narrationText: '#be185d',
        themeBg: '#fefce8',
        themeContainer: '#fef9e7',
        themeText: '#4a5568',
        themeAccent: '#84cc16'
    },
    'summer': {
        systemBg: '#cffafe',
        systemBorder: '#22d3ee',
        systemText: '#0e7490',
        narrationBg: '#f0f9ff',
        narrationText: '#0284c7',
        themeBg: '#f0fdfa',
        themeContainer: '#ccfbf1',
        themeText: '#134e4a',
        themeAccent: '#14b8a6'
    },
    'autumn': {
        systemBg: '#fed7aa',
        systemBorder: '#fb923c',
        systemText: '#9a3412',
        narrationBg: '#fef3c7',
        narrationText: '#92400e',
        themeBg: '#fffbeb',
        themeContainer: '#fef3c7',
        themeText: '#78350f',
        themeAccent: '#f59e0b'
    },
    'winter': {
        systemBg: '#dbeafe',
        systemBorder: '#93c5fd',
        systemText: '#1e3a8a',
        narrationBg: '#f0f9ff',
        narrationText: '#075985',
        themeBg: '#f8fafc',
        themeContainer: '#f1f5f9',
        themeText: '#334155',
        themeAccent: '#60a5fa'
    },
    'ccfolia': {
        systemBg: '#e0f2fe',
        systemBorder: '#4297ae',
        systemText: '#0c4a6e',
        narrationBg: '#2a2a2a',
        narrationText: '#d1d5db',
        themeBg: '#1e1e1e',
        themeContainer: '#2a2a2a',
        themeText: '#e5e7eb',
        themeAccent: '#3f51b5'
    }
};


const colorPresetSelect = document.getElementById('color-preset');
if (colorPresetSelect) {
    colorPresetSelect.addEventListener('change', (e) => {
        const preset = colorPresets[e.target.value];
        if (preset) {
            elements.systemBgColorInput.value = preset.systemBg;
            elements.systemBorderColorInput.value = preset.systemBorder;
            elements.systemTextColorInput.value = preset.systemText;
            elements.narrationBgColorInput.value = preset.narrationBg;
            elements.narrationTextColorInput.value = preset.narrationText;
            elements.themeBgColorInput.value = preset.themeBg;
            elements.themeContainerColorInput.value = preset.themeContainer;
            elements.themeTextColorInput.value = preset.themeText;
            elements.themeAccentColorInput.value = preset.themeAccent;
        }
        
        uiController.saveSettings(elements);
    });
}


const colorInputs = [
    elements.systemBgColorInput,
    elements.systemBorderColorInput,
    elements.systemTextColorInput,
    elements.narrationBgColorInput,
    elements.narrationTextColorInput,
    elements.themeBgColorInput,
    elements.themeContainerColorInput,
    elements.themeTextColorInput,
    elements.themeAccentColorInput
];

colorInputs.forEach(input => {
    if (input) {
        input.addEventListener('input', () => {
            if (colorPresetSelect && colorPresetSelect.value !== 'custom') {
                colorPresetSelect.value = 'custom';
                
                uiController.saveSettings(elements);
            }
        });
    }
});

</script>
</body>
</html>
